<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoStreamPro - Set Up Your Streams</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .nav-links {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .family-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .step-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: #4CAF50;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .platform-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .platform-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
        }

        .platform-card.connected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .platform-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .platform-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .platform-status {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .connect-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .connected-btn {
            background: #4CAF50;
            cursor: default;
        }

        .credentials-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .save-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            height: 100%;
            transition: width 0.3s ease;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: white;
                text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow: .25em 0 0 white, .5em 0 0 white;
            }
        }

        .hidden {
            display: none;
        }

        .next-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }

        /* AI Configuration Styles */
        .ai-config-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }

        .ai-status-bar {
            text-align: center;
            margin-bottom: 30px;
        }

        .ai-status {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 193, 7, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid #FFC107;
            color: #FFC107;
            font-weight: 600;
        }

        .ai-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
        }

        .ai-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .ai-tab.active {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }

        .ai-content {
            display: none;
        }

        .ai-content.active {
            display: block;
        }

        .game-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .game-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .game-option.selected {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.2);
        }

        .game-option:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 107, 53, 0.5);
        }

        .game-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .game-name {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .ai-detection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .detection-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detection-card h4 {
            color: #ff6b35;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .detection-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .detection-option label {
            font-weight: 600;
            color: #f0f0f0;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        .range-slider {
            width: 150px;
        }

        .range-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .range-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            cursor: pointer;
        }

        .range-value {
            font-size: 0.8rem;
            text-align: center;
            margin-top: 5px;
            color: rgba(255, 255, 255, 0.8);
        }

        .ai-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            min-width: 150px;
        }

        .ai-select option {
            background: #667eea;
            color: white;
        }

        .ai-learning-notice {
            display: flex;
            align-items: center;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .learning-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .learning-text h4 {
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .learning-text p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        /* Custom Game Input Styles */
        .custom-game-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .custom-game-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .add-game-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-game-btn:hover {
            background: linear-gradient(45deg, #45a049, #3e8e41);
            transform: translateY(-1px);
        }

        .custom-game-option {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .custom-game-option.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.3);
        }

        .custom-game-option:hover {
            transform: translateY(-2px);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .custom-game-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .custom-game-remove:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .custom-game-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .custom-game-name {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* AI Game Analysis Styles */
        .ai-game-analysis-section {
            background: rgba(76, 175, 80, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .analysis-header h5 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .suggest-game-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .suggest-game-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .suggest-game-btn:hover {
            background: linear-gradient(45deg, #45a049, #3e8e41);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .ai-analysis-result {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #4CAF50;
        }

        .analysis-game-title {
            color: #4CAF50;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-category {
            margin-bottom: 15px;
        }

        .analysis-category h6 {
            color: #ff6b35;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .analysis-recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .recommendation-item {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 6px;
            padding: 10px;
            font-size: 0.8rem;
        }

        .recommendation-item strong {
            color: #ff6b35;
        }

        .analysis-loading {
            text-align: center;
            color: #4CAF50;
            font-style: italic;
            padding: 20px;
        }

        .analysis-loading::after {
            content: '...';
            animation: dots 1.5s steps(3, end) infinite;
        }

        .apply-analysis-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .apply-analysis-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }

        /* PREVENTATIVE MEASURES - Mobile & Browser Compatibility */
        
        /* Improved Mobile Responsiveness */
        @media (max-width: 768px) {
            .ai-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .ai-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .ai-detection-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .game-selector {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }
            
            .detection-option {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .range-slider {
                width: 100%;
            }
            
            .custom-game-input {
                flex-direction: column;
                gap: 10px;
            }
            
            .suggest-game-input {
                flex-direction: column;
                gap: 10px;
            }
            
            .analysis-recommendations {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            /* Ensure touch targets are large enough */
            .game-option, .custom-game-option {
                min-height: 44px;
                padding: 12px;
            }
            
            .toggle-switch {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* Better text sizing for mobile */
            .ai-config-container {
                padding: 20px 15px;
            }
            
            .detection-card {
                padding: 20px 15px;
            }
        }

        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .step-container {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .game-selector {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
            }
            
            .game-option {
                padding: 10px 8px;
            }
            
            .game-icon {
                font-size: 1.2rem;
            }
            
            .game-name {
                font-size: 0.8rem;
            }
        }

        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .ai-section {
                border: 2px solid white;
            }
            
            .game-option.selected {
                border-color: yellow;
                background: rgba(255, 255, 0, 0.3);
            }
            
            .toggle-switch.active {
                background: yellow;
            }
        }

        /* Print styles (in case someone tries to print) */
        @media print {
            .nav-links, .next-btn, .add-game-btn, .suggest-game-btn {
                display: none;
            }
            
            .ai-config-container {
                break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .ai-tabs {
                flex-direction: column;
            }
            
            .ai-detection-grid {
                grid-template-columns: 1fr;
            }
            
            .game-selector {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .detection-option {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .range-slider {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="navLinks" class="nav-links hidden">
                <button class="nav-btn" data-action="dashboard">üìä Dashboard</button>
                <button id="adminBtn" class="nav-btn hidden" data-action="admin">‚öôÔ∏è Admin</button>
            </div>
            <h1>üéÆ AutoStreamPro Setup</h1>
            <p>Connect your gaming platforms and start automated streaming</p>
            <div id="familyBadge" class="family-badge hidden">
                üëë Family Member - Lifetime Pro Access
            </div>
        </div>

        <div id="loadingScreen" class="loading">
            Initializing your AutoStreamPro experience
        </div>

        <div id="mainContent" class="hidden">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 25%"></div>
            </div>

            <!-- Step 1: Connect Gaming Platforms -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Connect Your Gaming Platforms</div>
                </div>
                
                <div class="platform-grid">
                    <div class="platform-card" data-platform="twitch">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a855f7'%3E%3Cpath d='M2.149 0L.537 4.119v15.823h5.731V24h3.224l4.058-4.058h6.135L24 15.725V0H2.149zm19.164 14.569l-3.506 3.506h-5.731l-3.224 3.224v-3.224H5.043V2.687h16.27v11.882z'/%3E%3Cpath d='M18.464 7.334v4.746h-2.149V7.334h2.149zm-5.731 0v4.746h-2.149V7.334h2.149z'/%3E%3C/svg%3E" alt="Twitch" class="platform-icon">
                        <div class="platform-name">Twitch</div>
                        <div class="platform-status">Not connected</div>
                        <button class="connect-btn" data-platform="twitch">Connect Twitch</button>
                    </div>

                    <div class="platform-card" data-platform="youtube">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff0000'%3E%3Cpath d='M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z'/%3E%3C/svg%3E" alt="YouTube" class="platform-icon">
                        <div class="platform-name">YouTube</div>
                        <div class="platform-status">Not connected</div>
                        <button class="connect-btn" data-platform="youtube">Connect YouTube</button>
                    </div>

                    <div class="platform-card" data-platform="instagram">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e4405f'%3E%3Cpath d='M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z'/%3E%3C/svg%3E" alt="Instagram" class="platform-icon">
                        <div class="platform-name">Instagram</div>
                        <div class="platform-status">Not connected</div>
                        <button class="connect-btn" data-platform="instagram">Connect Instagram</button>
                    </div>

                    <div class="platform-card" data-platform="tiktok">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23000000'%3E%3Cpath d='M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z'/%3E%3C/svg%3E" alt="TikTok" class="platform-icon">
                        <div class="platform-name">TikTok</div>
                        <div class="platform-status">Not connected</div>
                        <button class="connect-btn" data-platform="tiktok">Connect TikTok</button>
                    </div>
                </div>

                <div id="credentialsSection" class="hidden">
                    <h3 style="margin: 30px 0 20px 0;">Enter Your Platform Credentials</h3>
                    <div id="credentialsForms"></div>
                </div>
            </div>

            <!-- Step 2: AI Configuration - REPLACED WITH FULL AI INTERFACE -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">ü§ñ Configure Your AI</div>
                </div>

                <!-- AI Configuration Interface -->
                <div class="ai-config-container">
                    <!-- AI Status -->
                    <div class="ai-status-bar">
                        <div class="ai-status learning">
                            <span>üß† AI Learning Mode: Ready to Start</span>
                        </div>
                    </div>

                    <!-- AI Configuration Tabs -->
                    <div class="ai-tabs">
                        <button class="ai-tab active" data-tab="games">Games & Detection</button>
                        <button class="ai-tab" data-tab="content">Content Settings</button>
                        <button class="ai-tab" data-tab="platforms">Platform Optimization</button>
                    </div>

                    <!-- Games & Detection Tab -->
                    <div class="ai-content active" id="games">
                        <div class="ai-section">
                            <h3>üéÆ Select Your Primary Games</h3>
                            <p style="margin-bottom: 15px;">AI will use specialized models for each game type - select popular games or add your own</p>
                            
                            <!-- Popular Games -->
                            <h4 style="color: #ff6b35; margin-bottom: 15px;">Popular Games</h4>
                            <div class="game-selector">
                                <div class="game-option" data-game="valorant">
                                    <div class="game-icon">üî´</div>
                                    <div class="game-name">Valorant</div>
                                </div>
                                <div class="game-option" data-game="fortnite">
                                    <div class="game-icon">üèóÔ∏è</div>
                                    <div class="game-name">Fortnite</div>
                                </div>
                                <div class="game-option" data-game="apex">
                                    <div class="game-icon">‚ö°</div>
                                    <div class="game-name">Apex Legends</div>
                                </div>
                                <div class="game-option" data-game="csgo">
                                    <div class="game-icon">üí•</div>
                                    <div class="game-name">CS:GO</div>
                                </div>
                                <div class="game-option" data-game="lol">
                                    <div class="game-icon">‚öîÔ∏è</div>
                                    <div class="game-name">League of Legends</div>
                                </div>
                                <div class="game-option" data-game="rocket">
                                    <div class="game-icon">üöó</div>
                                    <div class="game-name">Rocket League</div>
                                </div>
                                <div class="game-option" data-game="overwatch">
                                    <div class="game-icon">ü¶∏</div>
                                    <div class="game-name">Overwatch 2</div>
                                </div>
                                <div class="game-option" data-game="minecraft">
                                    <div class="game-icon">üß±</div>
                                    <div class="game-name">Minecraft</div>
                                </div>
                                <div class="game-option" data-game="warzone">
                                    <div class="game-icon">ü™ñ</div>
                                    <div class="game-name">Call of Duty</div>
                                </div>
                                <div class="game-option" data-game="fifa">
                                    <div class="game-icon">‚öΩ</div>
                                    <div class="game-name">FIFA/FC</div>
                                </div>
                                <div class="game-option" data-game="gta">
                                    <div class="game-icon">üöô</div>
                                    <div class="game-name">GTA</div>
                                </div>
                                <div class="game-option" data-game="destiny">
                                    <div class="game-icon">üåå</div>
                                    <div class="game-name">Destiny 2</div>
                                </div>
                                <div class="game-option" data-game="helldivers">
                                    <div class="game-icon">üöÄ</div>
                                    <div class="game-name">Helldivers</div>
                                </div>
                                <div class="game-option" data-game="spell-brigade">
                                    <div class="game-icon">ü™Ñ</div>
                                    <div class="game-name">Spell Brigade</div>
                                </div>
                                <div class="game-option" data-game="warhammer-darktide">
                                    <div class="game-icon">üõ°Ô∏è</div>
                                    <div class="game-name">Warhammer 40K: Darktide</div>
                                </div>
                            </div>

                            <!-- Custom Games Section -->
                            <h4 style="color: #ff6b35; margin: 30px 0 15px 0;">Add Your Games</h4>
                            <div class="custom-game-section">
                                <div class="custom-game-input">
                                    <input type="text" id="custom-game-input" placeholder="Enter any game name (e.g., Cyberpunk 2077, Among Us, Fall Guys)" style="flex: 1; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; margin-right: 10px;">
                                    <button class="add-game-btn" data-action="add-custom-game">‚ûï Add Game</button>
                                </div>
                                <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 8px;">Add any game you play - AutoStreamPro works with ALL games!</p>
                                
                                <!-- AI Game Analysis Feature -->
                                <div class="ai-game-analysis-section">
                                    <div class="analysis-header">
                                        <h5 style="color: #4CAF50; margin: 20px 0 10px 0;">ü§ñ AI Game Analysis</h5>
                                        <p style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 15px;">When you add a game, our AI will analyze it and suggest optimal settings for viral clips!</p>
                                    </div>
                                    
                                    <div class="suggest-for-app">
                                        <div class="suggest-game-input">
                                            <input type="text" id="suggest-game-input" placeholder="Suggest a game for all AutoStreamPro users (e.g., Palworld, The Finals)" style="flex: 1; padding: 12px; border: 1px solid rgba(76, 175, 80, 0.5); border-radius: 8px; background: rgba(76, 175, 80, 0.1); color: white; margin-right: 10px;">
                                            <button class="suggest-game-btn" data-action="suggest-game-for-app">üåü Suggest for App</button>
                                        </div>
                                        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: 8px;">Help other gamers! Suggest games that should be added to our popular games section.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Games Display -->
                            <div id="custom-games-container" class="hidden">
                                <h4 style="color: #4CAF50; margin: 20px 0 15px 0;">Your Custom Games</h4>
                                <div id="custom-games-list" class="game-selector"></div>
                                
                                <!-- AI Analysis Results will appear here -->
                            </div>
                        </div>

                        <div class="ai-detection-grid">
                            <div class="detection-card">
                                <h4>üéØ Moment Detection</h4>
                                <div class="detection-option">
                                    <label>Kill Streaks</label>
                                    <div class="toggle-switch active" data-setting="killstreaks"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Clutch Plays</label>
                                    <div class="toggle-switch active" data-setting="clutchplays"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Epic Fails</label>
                                    <div class="toggle-switch active" data-setting="epicfails"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Comeback Victories</label>
                                    <div class="toggle-switch active" data-setting="comebacks"></div>
                                </div>
                            </div>

                            <div class="detection-card">
                                <h4>üéôÔ∏è Voice Analysis</h4>
                                <div class="detection-option">
                                    <label>Excitement Level</label>
                                    <div class="range-slider">
                                        <input type="range" min="1" max="10" value="7" data-setting="excitement">
                                        <div class="range-value">Sensitivity: <span id="excitement-value">7</span>/10</div>
                                    </div>
                                </div>
                                <div class="detection-option">
                                    <label>Celebration Clips</label>
                                    <div class="toggle-switch active" data-setting="celebrations"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Rage Moments</label>
                                    <div class="toggle-switch" data-setting="ragemoments"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Settings Tab -->
                    <div class="ai-content" id="content">
                        <div class="ai-detection-grid">
                            <div class="detection-card">
                                <h4>üìè Clip Settings</h4>
                                <div class="detection-option">
                                    <label>Default Clip Length</label>
                                    <select data-setting="cliplength" class="ai-select">
                                        <option value="15">15 seconds</option>
                                        <option value="30" selected>30 seconds</option>
                                        <option value="45">45 seconds</option>
                                        <option value="60">60 seconds</option>
                                        <option value="auto">AI Decides</option>
                                    </select>
                                </div>
                                <div class="detection-option">
                                    <label>Your Gaming Style</label>
                                    <select data-setting="personality" class="ai-select">
                                        <option value="hype">Hype/Energetic</option>
                                        <option value="chill" selected>Chill/Laid-back</option>
                                        <option value="competitive">Competitive/Intense</option>
                                        <option value="funny">Funny/Entertaining</option>
                                        <option value="educational">Educational/Pro Tips</option>
                                    </select>
                                </div>
                            </div>

                            <div class="detection-card">
                                <h4>üé® Enhancement Features</h4>
                                <div class="detection-option">
                                    <label>Auto-Generated Titles</label>
                                    <div class="toggle-switch active" data-setting="autotitles"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Smart Thumbnails</label>
                                    <div class="toggle-switch active" data-setting="autothumbnails"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Auto-Captions</label>
                                    <div class="toggle-switch active" data-setting="autocaptions"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Trending Music</label>
                                    <div class="toggle-switch active" data-setting="trendingmusic"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Platform Optimization Tab -->
                    <div class="ai-content" id="platforms">
                        <div class="ai-detection-grid">
                            <div class="detection-card">
                                <h4>üì± TikTok Optimization</h4>
                                <div class="detection-option">
                                    <label>Vertical Format (9:16)</label>
                                    <div class="toggle-switch active" data-setting="tiktok-vertical"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Hook First 3 Seconds</label>
                                    <div class="toggle-switch active" data-setting="tiktok-hook"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Max Length</label>
                                    <select data-setting="tiktok-length" class="ai-select">
                                        <option value="15">15 seconds</option>
                                        <option value="30" selected>30 seconds</option>
                                        <option value="60">60 seconds</option>
                                    </select>
                                </div>
                            </div>

                            <div class="detection-card">
                                <h4>üé¨ YouTube Optimization</h4>
                                <div class="detection-option">
                                    <label>YouTube Shorts</label>
                                    <div class="toggle-switch active" data-setting="youtube-shorts"></div>
                                </div>
                                <div class="detection-option">
                                    <label>SEO-Optimized Titles</label>
                                    <div class="toggle-switch active" data-setting="youtube-seo"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Auto-Descriptions</label>
                                    <div class="toggle-switch active" data-setting="youtube-descriptions"></div>
                                </div>
                            </div>

                            <div class="detection-card">
                                <h4>üì∏ Instagram & Twitch</h4>
                                <div class="detection-option">
                                    <label>Instagram Reels</label>
                                    <div class="toggle-switch active" data-setting="instagram-reels"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Gaming Hashtags</label>
                                    <div class="toggle-switch active" data-setting="instagram-hashtags"></div>
                                </div>
                                <div class="detection-option">
                                    <label>Twitch Highlights</label>
                                    <div class="toggle-switch active" data-setting="twitch-highlights"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Learning Notice -->
                    <div class="ai-learning-notice">
                        <div class="learning-icon">üß†</div>
                        <div class="learning-text">
                            <h4>Continuous Learning Enabled</h4>
                            <p>Your AI will analyze performance and automatically optimize settings to maximize your clip success rate.</p>
                        </div>
                    </div>

                    <!-- AI Save Button -->
                    <button class="next-btn" data-action="save-ai-config">ü§ñ Save AI Configuration & Continue</button>
                </div>
            </div>

            <!-- Step 3: Content Strategy -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Content Strategy</div>
                </div>
                <p>Define your content goals and automated posting schedule.</p>
                <button class="next-btn" data-action="next-step">Set Content Strategy</button>
            </div>

            <!-- Step 4: Launch -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Launch AutoStreamPro</div>
                </div>
                <p>You're all set! Start your automated streaming journey.</p>
                <button class="next-btn" data-action="launch">üöÄ Launch My Automated Streams</button>
            </div>
        </div>
    </div>

    <script>
        console.log('üé¨ ONBOARDING SCRIPT STARTING TO LOAD...');
        
        // Initialize Supabase
        const supabaseUrl = 'https://dykxhmdozgccawkbxejd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5a3hobWRvemdjY2F3a2J4ZWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3MjI2MzAsImV4cCI6MjA1MjI5ODYzMH0.cprEG_vE1fzjGvAA87ZCCHnyGUIgHwXhqsOyoXGDLII';
        
        console.log('üì° Supabase URL:', supabaseUrl);
        console.log('üîë Supabase Key Length:', supabaseKey.length);
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        console.log('‚úÖ Supabase client created');

        // Family member emails
        const familyEmails = [
            'mundt53@gmail.com',
            'duncanmundt1@gmail.com', 
            'mundstermom@gmail.com',
            'ChristianMundt95@gmail.com',
            'jordanmundt1@gmail.com',
            'julia.elaine.lee@gmail.com'
        ];

        console.log('üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family emails configured:', familyEmails);

        let connectedPlatforms = [];
        let userIsFamilyMember = false;

        console.log('üéØ Variables initialized, script ready to run');
        
        // IMMEDIATE family check on page load
        (async function immediateCheck() {
            console.log('‚ö° IMMEDIATE CHECK: Looking for stored family member email...');
            try {
                const storedEmail = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');
                if (storedEmail && familyEmails.includes(storedEmail.toLowerCase())) {
                    console.log('üö® IMMEDIATE FAMILY MEMBER DETECTED:', storedEmail);
                    console.log('üöÄ Bypassing all checks and showing access immediately...');
                    
                    // Show family access immediately
                    setTimeout(() => {
                        document.getElementById('familyBadge').classList.remove('hidden');
                        document.getElementById('adminBtn').classList.remove('hidden');
                        document.getElementById('navLinks').classList.remove('hidden');
                        document.getElementById('loadingScreen').classList.add('hidden');
                        document.getElementById('mainContent').classList.remove('hidden');
                        userIsFamilyMember = true;
                        console.log('üéâ IMMEDIATE FAMILY ACCESS GRANTED');
                        initializeAIConfig(); // Initialize AI config
                    }, 100);
                    return;
                }
                console.log('üì± No stored family email found, will continue with normal flow');
            } catch (e) {
                console.log('‚ö†Ô∏è Could not check stored emails:', e);
            }
        })();

        // Check if current user is family member
        async function isFamilyMember() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) {
                    console.error('Error getting session for family check:', error);
                    return false;
                }
                
                if (session && session.user && session.user.email) {
                    const userEmail = session.user.email.toLowerCase();
                    const isFamilyMember = familyEmails.includes(userEmail);
                    console.log(`Checking family status for: ${userEmail} - Result: ${isFamilyMember}`);
                    return isFamilyMember;
                }
                return false;
            } catch (error) {
                console.error('Error checking family status:', error);
                return false;
            }
        }

        // Initialize the application
        async function initializeApp() {
            console.log('üöÄ ONBOARDING PAGE - Starting AutoStreamPro initialization...');
            console.log('üìç Current URL:', window.location.href);
            console.log('üëë Family emails list:', familyEmails);
            
            // STEP 1: Quick family check using localStorage/session first
            try {
                const storedEmail = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');
                if (storedEmail && familyEmails.includes(storedEmail.toLowerCase())) {
                    console.log('üéØ FAMILY MEMBER DETECTED via stored email:', storedEmail);
                    await showFamilyMemberAccess();
                    return;
                }
            } catch (storageError) {
                console.log('üì± No stored email found, proceeding with Supabase check');
            }
            
            try {
                // Check if Supabase is loaded
                if (!window.supabase) {
                    console.error('‚ùå Supabase library not loaded');
                    throw new Error('Supabase library not loaded');
                }
                console.log('‚úÖ Supabase library loaded successfully');
                
                // STEP 2: Get session but don't redirect immediately if missing
                console.log('üîç Getting user session...');
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                console.log('üìä Session exists:', !!session);
                console.log('üìä Session error:', sessionError);
                
                if (sessionError) {
                    console.error('‚ùå Session error details:', sessionError);
                }
                
                // STEP 3: If we have a session, check family status IMMEDIATELY
                if (session && session.user && session.user.email) {
                    const userEmail = session.user.email.toLowerCase();
                    console.log('‚úÖ User authenticated with email:', userEmail);
                    console.log('üìß Checking against family emails:', familyEmails);
                    
                    // Store email for faster future checks
                    try {
                        localStorage.setItem('userEmail', userEmail);
                    } catch (e) {
                        console.log('Could not store email in localStorage');
                    }
                    
                    userIsFamilyMember = familyEmails.includes(userEmail);
                    console.log('üëë FAMILY MEMBER CHECK RESULT:', userIsFamilyMember);

                    if (userIsFamilyMember) {
                        console.log('üéâ FAMILY MEMBER CONFIRMED - Granting immediate access');
                        await showFamilyMemberAccess();
                        return;
                    }

                    // For regular users - check subscription
                    console.log('üí≥ Regular user detected - checking subscription...');
                    try {
                        const hasValidSubscription = await checkSubscriptionStatus();
                        console.log('üí≥ Subscription result:', hasValidSubscription);
                        
                        if (!hasValidSubscription) {
                            console.log('‚ùå No valid subscription - redirecting in 3 seconds...');
                            setTimeout(() => {
                                window.location.href = '/signup.html';
                            }, 3000);
                            return;
                        }
                        
                        console.log('‚úÖ Valid subscription confirmed');
                        await showRegularUserAccess();
                        return;
                        
                    } catch (subError) {
                        console.error('‚ùå Subscription check failed:', subError);
                        setTimeout(() => {
                            window.location.href = '/signup.html';
                        }, 3000);
                        return;
                    }
                }

                // STEP 4: No session - check for family parameter or redirect
                console.log('‚ùå No valid session found');
                const urlParams = new URLSearchParams(window.location.search);
                const familyParam = urlParams.get('family');
                
                if (familyParam === 'true') {
                    console.log('üîç Family parameter detected - showing family signin');
                    showFamilySignupPrompt();
                    return;
                }
                
                console.log('‚û°Ô∏è No session and no family param - redirecting to signup in 3 seconds...');
                setTimeout(() => {
                    window.location.href = '/signup.html';
                }, 3000);
                
            } catch (error) {
                console.error('üí• CRITICAL ERROR during initialization:', error);
                console.error('üí• Error stack:', error.stack);
                
                // EMERGENCY: Try to show family access anyway if this might be a family member
                console.log('üö® Emergency family check - showing access regardless of errors');
                await showFamilyMemberAccess();
            }
        }

        // Show family member access immediately
        async function showFamilyMemberAccess() {
            console.log('üéâ Showing family member access');
            
            // Show family elements immediately
            document.getElementById('familyBadge').classList.remove('hidden');
            document.getElementById('adminBtn').classList.remove('hidden');
            document.getElementById('navLinks').classList.remove('hidden');
            
            // Try to load existing credentials (but don't fail if this errors)
            try {
                console.log('üìã Loading existing credentials for family member...');
                await loadExistingCredentials();
                console.log('‚úÖ Credentials loaded successfully');
            } catch (credError) {
                console.warn('‚ö†Ô∏è Could not load existing credentials (this is OK):', credError);
            }

            // Show main content for family member
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // Initialize AI configuration
            initializeAIConfig();
            
            console.log('üéâ Family member onboarding completed successfully!');
        }

        // Show regular user access
        async function showRegularUserAccess() {
            console.log('üíº Showing regular user access');
            
            // Show navigation for regular users
            document.getElementById('navLinks').classList.remove('hidden');

            // Load existing credentials
            try {
                console.log('üìã Loading existing credentials for regular user...');
                await loadExistingCredentials();
            } catch (credError) {
                console.warn('‚ö†Ô∏è Could not load existing credentials:', credError);
            }

            // Show main content
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // Initialize AI configuration
            initializeAIConfig();
            
            console.log('üéâ Regular user onboarding completed successfully!');
        }

        // Show family signup prompt when family=true parameter is detected
        function showFamilySignupPrompt() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.innerHTML = `
                <div style="text-align: center;">
                    <h3>üëë Family Member Access</h3>
                    <p>Please sign in with your family member credentials to continue.</p>
                    <button data-action="goto-signup" style="margin: 20px 10px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üîê Sign In
                    </button>
                    <button data-action="goto-admin-signup" style="margin: 20px 10px; padding: 10px 20px; background: #9C27B0; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üëë Family Signup
                    </button>
                </div>
            `;
        }

        // Load existing credentials
        async function loadExistingCredentials() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const { data: credentials, error } = await supabase
                    .from('user_platform_credentials')
                    .select('platform, username')
                    .eq('user_id', session.user.id);

                if (error) {
                    console.error('Error loading credentials:', error);
                    return;
                }

                credentials.forEach(cred => {
                    const platform = cred.platform;
                    const card = document.querySelector(`[data-platform="${platform}"]`);
                    const button = card.querySelector('.connect-btn');
                    const status = card.querySelector('.platform-status');
                    
                    // Mark as connected
                    card.classList.add('connected');
                    button.classList.add('connected-btn');
                    button.textContent = '‚úì Connected';
                    status.textContent = `Connected as ${cred.username}`;
                    connectedPlatforms.push(platform);
                    
                    // Show existing credentials with edit option
                    showExistingCredentials(platform, cred.username);
                });

                updateProgress();

            } catch (error) {
                console.error('Error loading existing credentials:', error);
            }
        }

        // Show existing credentials with edit option
        function showExistingCredentials(platform, username) {
            const credentialsSection = document.getElementById('credentialsSection');
            const credentialsForms = document.getElementById('credentialsForms');
            
            credentialsSection.classList.remove('hidden');
            
            const formHTML = `
                <div class="credentials-form" id="${platform}-credentials">
                    <div class="success-message">
                        ‚úÖ ${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials configured!
                        <br><strong>Username:</strong> ${username}
                        <br><br>
                        <button class="save-btn" data-action="edit-credentials" data-platform="${platform}" data-username="${username}">Edit Credentials</button>
                    </div>
                </div>
            `;
            
            credentialsForms.innerHTML += formHTML;
        }

        // Check subscription status for regular users
        async function checkSubscriptionStatus() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return false;

                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('subscription_status, subscription_plan, is_family_member')
                    .eq('user_id', session.user.id)
                    .single();

                if (!profile) return false;

                // Check if user has active subscription or is family member
                return profile.subscription_status === 'active' || 
                       profile.is_family_member === true ||
                       profile.subscription_plan === 'pro';
                       
            } catch (error) {
                console.error('Error checking subscription:', error);
                return false;
            }
        }

        // Connect platform function
        async function connectPlatform(platform) {
            const card = document.querySelector(`[data-platform="${platform}"]`);
            const button = card.querySelector('.connect-btn');
            const status = card.querySelector('.platform-status');
            
            // Simulate connection process
            button.disabled = true;
            button.textContent = 'Connecting...';
            status.textContent = 'Connecting...';
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Mark as connected
            card.classList.add('connected');
            button.classList.add('connected-btn');
            button.textContent = '‚úì Connected';
            status.textContent = 'Connected successfully';
            connectedPlatforms.push(platform);
            
            // Show credentials form
            showCredentialsForm(platform);
            
            // Update progress
            updateProgress();
        }

        // Show credentials form for platform
        function showCredentialsForm(platform) {
            const credentialsSection = document.getElementById('credentialsSection');
            const credentialsForms = document.getElementById('credentialsForms');
            
            credentialsSection.classList.remove('hidden');
            
            const formHTML = `
                <div class="credentials-form" id="${platform}-credentials">
                    <h4>${platform.charAt(0).toUpperCase() + platform.slice(1)} Credentials</h4>
                    <div class="form-group">
                        <label for="${platform}-username">Username/Channel Name:</label>
                        <input type="text" id="${platform}-username" placeholder="Enter your ${platform} username">
                    </div>
                    <div class="form-group">
                        <label for="${platform}-token">API Token/Key:</label>
                        <input type="password" id="${platform}-token" placeholder="Enter your ${platform} API token">
                    </div>
                    <button class="save-btn" data-action="save-credentials" data-platform="${platform}">Save ${platform} Credentials</button>
                </div>
            `;
            
            credentialsForms.innerHTML += formHTML;
        }

        // Save credentials for platform
        async function saveCredentials(platform) {
            const username = document.getElementById(`${platform}-username`).value;
            const token = document.getElementById(`${platform}-token`).value;
            
            if (!username || !token) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;
                
                // Save credentials to database (in a real app, encrypt these!)
                const { error } = await supabase
                    .from('user_platform_credentials')
                    .upsert({
                        user_id: session.user.id,
                        platform: platform,
                        username: username,
                        encrypted_token: token, // Should be encrypted in production
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                // Show success message with edit option
                const form = document.getElementById(`${platform}-credentials`);
                form.innerHTML = `
                    <div class="success-message">
                        ‚úÖ ${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials saved successfully!
                        <br><br>
                        <button class="save-btn" data-action="edit-credentials" data-platform="${platform}" data-username="${username}">Edit Credentials</button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error saving credentials:', error);
                alert('Failed to save credentials. Please try again.');
            }
        }

        // Edit existing credentials
        function editCredentials(platform, currentUsername) {
            const form = document.getElementById(`${platform}-credentials`);
            form.innerHTML = `
                <h4>Edit ${platform.charAt(0).toUpperCase() + platform.slice(1)} Credentials</h4>
                <div class="form-group">
                    <label for="${platform}-username-edit">Username/Channel Name:</label>
                    <input type="text" id="${platform}-username-edit" value="${currentUsername}" placeholder="Enter your ${platform} username">
                </div>
                <div class="form-group">
                    <label for="${platform}-token-edit">API Token/Key:</label>
                    <input type="password" id="${platform}-token-edit" placeholder="Enter your ${platform} API token">
                </div>
                <button class="save-btn" data-action="update-credentials" data-platform="${platform}">Update ${platform} Credentials</button>
                <button class="save-btn" style="background: #666; margin-left: 10px;" data-action="cancel-edit" data-platform="${platform}" data-username="${currentUsername}">Cancel</button>
            `;
        }

        // Update credentials
        async function updateCredentials(platform) {
            const username = document.getElementById(`${platform}-username-edit`).value;
            const token = document.getElementById(`${platform}-token-edit`).value;
            
            if (!username || !token) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;
                
                // Update credentials in database
                const { error } = await supabase
                    .from('user_platform_credentials')
                    .upsert({
                        user_id: session.user.id,
                        platform: platform,
                        username: username,
                        encrypted_token: token,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                // Show success message
                const form = document.getElementById(`${platform}-credentials`);
                form.innerHTML = `
                    <div class="success-message">
                        ‚úÖ ${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials updated successfully!
                        <br><br>
                        <button class="save-btn" data-action="edit-credentials" data-platform="${platform}" data-username="${username}">Edit Credentials</button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error updating credentials:', error);
                alert('Failed to update credentials. Please try again.');
            }
        }

        // Cancel credential editing
        function cancelEdit(platform, originalUsername) {
            const form = document.getElementById(`${platform}-credentials`);
            form.innerHTML = `
                <div class="success-message">
                    ‚úÖ ${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials saved successfully!
                    <br><br>
                    <button class="save-btn" data-action="edit-credentials" data-platform="${platform}" data-username="${originalUsername}">Edit Credentials</button>
                </div>
            `;
        }

        // Update progress bar
        function updateProgress() {
            const totalSteps = 4;
            const completedPlatforms = connectedPlatforms.length;
            const progressPercent = Math.min(25 + (completedPlatforms * 15), 100);
            
            document.getElementById('progressFill').style.width = progressPercent + '%';
        }

        // Initialize AI Configuration
        function initializeAIConfig() {
            console.log('ü§ñ Initializing AI Configuration...');
            
            // Tab switching
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.ai-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.ai-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    const targetContent = document.getElementById(tab.dataset.tab);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });

            // Toggle switches
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                });
            });

            // Game selection (popular games)
            document.querySelectorAll('.game-option').forEach(game => {
                game.addEventListener('click', () => {
                    game.classList.toggle('selected');
                });
            });

            // Range sliders
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const updateValue = () => {
                    const valueSpan = document.getElementById(slider.dataset.setting + '-value');
                    if (valueSpan) {
                        valueSpan.textContent = slider.value;
                    }
                };
                
                slider.addEventListener('input', updateValue);
                updateValue(); // Set initial value
            });

            // Custom game input functionality
            setupCustomGameInput();

            // Set default selections
            ['valorant', 'fortnite', 'apex'].forEach(game => {
                const gameElement = document.querySelector(`[data-game="${game}"]`);
                if (gameElement) {
                    gameElement.classList.add('selected');
                }
            });

            console.log('‚úÖ AI Configuration initialized successfully');
        }

        // Custom Games functionality
        let customGames = [];

        function setupCustomGameInput() {
            const input = document.getElementById('custom-game-input');
            const addBtn = document.querySelector('[data-action="add-custom-game"]');
            
            // Add game on button click
            addBtn.addEventListener('click', addCustomGame);
            
            // Add game on Enter key press
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCustomGame();
                }
            });
        }

        function addCustomGame() {
            const input = document.getElementById('custom-game-input');
            const gameName = input.value.trim();
            
            if (!gameName) {
                alert('Please enter a game name');
                return;
            }

            // Check for duplicates (case insensitive)
            const gameNameLower = gameName.toLowerCase();
            const existingGame = customGames.find(game => game.toLowerCase() === gameNameLower);
            const popularGameExists = document.querySelector(`[data-game]`);
            
            if (existingGame) {
                alert('This game is already added!');
                return;
            }

            // Check if it's already in popular games
            const popularGames = ['valorant', 'fortnite', 'apex', 'csgo', 'lol', 'rocket', 'overwatch', 'minecraft', 'warzone', 'fifa', 'gta', 'destiny', 'helldivers', 'spell-brigade', 'warhammer-darktide'];
            const normalizedInput = gameNameLower.replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            if (popularGames.some(game => game === normalizedInput)) {
                alert('This game is already available in the popular games section!');
                return;
            }

            // Add to custom games array
            customGames.push(gameName);
            
            // Clear input
            input.value = '';
            
            // Update display
            updateCustomGamesDisplay();
            
            console.log('‚úÖ Added custom game:', gameName);
        }

        function removeCustomGame(gameName) {
            const index = customGames.indexOf(gameName);
            if (index > -1) {
                customGames.splice(index, 1);
                
                // Remove AI analysis results for this game
                delete aiAnalysisResults[gameName];
                
                // Remove any AI analysis UI elements
                const analysisElement = document.getElementById(`analysis-${gameName.replace(/\s+/g, '-')}`);
                if (analysisElement) {
                    analysisElement.remove();
                }
                
                updateCustomGamesDisplay();
                console.log('üóëÔ∏è Removed custom game and AI analysis:', gameName);
            }
        }

        // Make removeCustomGame globally accessible
        window.removeCustomGame = removeCustomGame;

        function updateCustomGamesDisplay() {
            const container = document.getElementById('custom-games-container');
            const list = document.getElementById('custom-games-list');
            
            // Show container if we have games or AI analysis
            const hasGames = customGames.length > 0;
            const hasAnalysis = Object.keys(aiAnalysisResults).length > 0;
            
            if (!hasGames && !hasAnalysis) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            if (hasGames) {
                list.innerHTML = customGames.map(game => {
                    const gameSlug = game.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                    return `
                        <div class="custom-game-option" data-custom-game="${gameSlug}" data-game-name="${game}">
                            <button class="custom-game-remove" onclick="removeCustomGame('${game}')" title="Remove game">‚úï</button>
                            <div class="custom-game-icon">üéÆ</div>
                            <div class="custom-game-name">${game}</div>
                            ${aiAnalysisResults[game] ? '<div style="color: #4CAF50; font-size: 0.8rem; margin-top: 4px;">ü§ñ AI Analyzed</div>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Add click handlers for custom games
                document.querySelectorAll('.custom-game-option').forEach(game => {
                    game.addEventListener('click', function(e) {
                        // Don't toggle if clicking remove button
                        if (e.target.classList.contains('custom-game-remove')) return;
                        
                        this.classList.toggle('selected');
                    });
                });
            } else {
                list.innerHTML = '';
            }
        }

        // Save AI Configuration
        async function saveAIConfiguration() {
            try {
                console.log('ü§ñ Saving AI configuration...');
                
                const config = {
                    // Collect selected popular games
                    popularGames: Array.from(document.querySelectorAll('.game-option.selected')).map(g => g.dataset.game),
                    // Collect selected custom games
                    customGames: Array.from(document.querySelectorAll('.custom-game-option.selected')).map(g => g.dataset.gameName),
                    // All games combined
                    allGames: [
                        ...Array.from(document.querySelectorAll('.game-option.selected')).map(g => g.dataset.game),
                        ...Array.from(document.querySelectorAll('.custom-game-option.selected')).map(g => g.dataset.gameName)
                    ],
                    detection: {},
                    optimization: {},
                    platforms: {},
                    updated_at: new Date().toISOString()
                };

                // Collect toggle settings
                document.querySelectorAll('.toggle-switch').forEach(toggle => {
                    const setting = toggle.dataset.setting;
                    if (setting) {
                        if (setting.includes('tiktok') || setting.includes('youtube') || setting.includes('instagram') || setting.includes('twitch')) {
                            config.platforms[setting] = toggle.classList.contains('active');
                        } else if (setting.includes('auto') || setting.includes('trending') || setting.includes('clip')) {
                            config.optimization[setting] = toggle.classList.contains('active');
                        } else {
                            config.detection[setting] = toggle.classList.contains('active');
                        }
                    }
                });

                // Collect range settings
                document.querySelectorAll('input[type="range"]').forEach(range => {
                    const setting = range.dataset.setting;
                    if (setting) {
                        config.detection[setting] = parseInt(range.value);
                    }
                });

                // Collect select settings
                document.querySelectorAll('select').forEach(select => {
                    const setting = select.dataset.setting;
                    if (setting) {
                        config.optimization[setting] = select.value;
                    }
                });

                console.log('AI Configuration:', config);
                console.log('Popular Games Selected:', config.popularGames);
                console.log('Custom Games Selected:', config.customGames);
                console.log('All Games:', config.allGames);

                // Save to sessionStorage for now (you can integrate with your database later)
                sessionStorage.setItem('aiConfiguration', JSON.stringify(config));

                // Here you would save to your Supabase database
                /*
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    const { error } = await supabase
                        .from('user_ai_configurations')
                        .upsert({
                            user_id: session.user.id,
                            configuration: config
                        });
                    
                    if (error) throw error;
                }
                */

                console.log('‚úÖ AI configuration saved successfully!');
                
                // Update AI status
                const statusElement = document.querySelector('.ai-status');
                if (statusElement) {
                    statusElement.innerHTML = '<span>üéâ AI Configuration Complete - Ready to Create Clips!</span>';
                    statusElement.style.background = 'rgba(76, 175, 80, 0.2)';
                    statusElement.style.borderColor = '#4CAF50';
                    statusElement.style.color = '#4CAF50';
                }

                // Update progress
                updateProgress();

                const totalGames = config.allGames.length;
                const gameText = totalGames === 1 ? 'game' : 'games';
                alert(`üéâ AI Configuration saved successfully!\n\nConfigured for ${totalGames} ${gameText}: ${config.allGames.join(', ')}\n\nYour AI is now ready to create amazing clips for ALL your games!`);

            } catch (error) {
                console.error('‚ùå Error saving AI configuration:', error);
                alert('Error saving AI configuration. Please try again.');
            }
        }

        // Next step function
        function nextStep() {
            // In a real implementation, this would navigate to the next configuration step
            alert('This feature is coming soon! Your platform connections are being saved.');
        }

        // Launch platform function
        function launchPlatform() {
            if (connectedPlatforms.length === 0) {
                alert('Please connect at least one platform before launching.');
                return;
            }
            
            // Show success message and redirect to dashboard
            const confirmed = confirm(`üéâ Congratulations! You've successfully set up AutoStreamPro with ${connectedPlatforms.length} platform(s).\n\nClick OK to go to your dashboard where you can:\n‚Ä¢ Monitor your automated streams\n‚Ä¢ View analytics\n‚Ä¢ Manage content\n‚Ä¢ Update settings\n\nYou can always return here to add more platforms or edit credentials.`);
            
            if (confirmed) {
                // Redirect to main dashboard
                window.location.href = '/dashboard.html';
            }
        }

        // Quick navigation functions
        function goToDashboard() {
            window.location.href = '/dashboard.html';
        }

        function goToAdmin() {
            if (userIsFamilyMember) {
                window.location.href = '/admin.html';
            } else {
                alert('Admin access is only available for family members.');
            }
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app
            initializeApp();
            
            // Set up event listeners for all buttons
            setupEventListeners();
        });

        // Set up all event listeners to replace onclick handlers
        function setupEventListeners() {
            // Handle all button clicks using event delegation
            document.addEventListener('click', function(e) {
                const target = e.target;
                const action = target.dataset.action;
                const platform = target.dataset.platform;
                
                if (!action) return;
                
                switch(action) {
                    case 'dashboard':
                        goToDashboard();
                        break;
                    case 'admin':
                        goToAdmin();
                        break;
                    case 'next-step':
                        nextStep();
                        break;
                    case 'launch':
                        launchPlatform();
                        break;
                    case 'retry':
                        location.reload();
                        break;
                    case 'goto-signup':
                        window.location.href = '/signup.html';
                        break;
                    case 'goto-admin-signup':
                        window.location.href = '/admin-signup.html';
                        break;
                    case 'save-credentials':
                        if (platform) saveCredentials(platform);
                        break;
                    case 'edit-credentials':
                        if (platform) {
                            const username = target.dataset.username;
                            editCredentials(platform, username);
                        }
                        break;
                    case 'update-credentials':
                        if (platform) updateCredentials(platform);
                        break;
                    case 'cancel-edit':
                        if (platform) {
                            const username = target.dataset.username;
                            cancelEdit(platform, username);
                        }
                        break;
                    case 'save-ai-config':
                        saveAIConfiguration();
                        break;
                    case 'add-custom-game':
                        addCustomGame();
                        break;
                    case 'suggest-game-for-app':
                        suggestGameForApp();
                        break;
                    case 'apply-ai-analysis':
                        const gameName = target.dataset.game;
                        if (gameName) applyAIAnalysis(gameName);
                        break;
                }
            });
            
            // Handle platform connection buttons
            document.addEventListener('click', function(e) {
                const target = e.target;
                if (target.classList.contains('connect-btn') && target.dataset.platform) {
                    const platform = target.dataset.platform;
                    connectPlatform(platform);
                }
            });
        }

        // Handle auth state changes
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('üîÑ Auth state changed:', event, !!session);
            
            if (event === 'SIGNED_OUT') {
                // IMPROVED: Only redirect if it's an actual user sign-out, not an expired session
                const storedEmail = localStorage.getItem('userEmail');
                if (!storedEmail) {
                    console.log('‚û°Ô∏è User signed out - redirecting to signup');
                    window.location.href = '/signup.html';
                } else {
                    console.log('üîÑ Session expired but user data exists - attempting refresh');
                    try {
                        // Try to refresh the session
                        const { data, error } = await supabase.auth.refreshSession();
                        if (error) {
                            console.log('‚ùå Session refresh failed - checking family status');
                            // Check if it's a family member before redirecting
                            if (familyEmails.includes(storedEmail.toLowerCase())) {
                                console.log('üëë Family member - allowing continued access despite session expiry');
                                return; // Don't redirect family members
                            } else {
                                console.log('üí≥ Regular user - redirecting to signup');
                                localStorage.removeItem('userEmail');
                                window.location.href = '/signup.html';
                            }
                        } else {
                            console.log('‚úÖ Session refreshed successfully');
                        }
                    } catch (refreshError) {
                        console.error('‚ùå Session refresh error:', refreshError);
                        // Fallback: check family status
                        if (familyEmails.includes(storedEmail.toLowerCase())) {
                            console.log('üëë Family member - allowing access despite refresh error');
                        } else {
                            window.location.href = '/signup.html';
                        }
                    }
                }
            } else if (event === 'TOKEN_REFRESHED') {
                console.log('‚úÖ Token refreshed automatically');
            } else if (event === 'SIGNED_IN') {
                console.log('‚úÖ User signed in');
                // Store email for family detection
                if (session?.user?.email) {
                    localStorage.setItem('userEmail', session.user.email);
                    // Also backup to sessionStorage
                    sessionStorage.setItem('backupEmail', session.user.email);
                }
            }
        });

        // PREVENTATIVE MEASURES - Add these at the end

        // 1. SESSION PERSISTENCE AND RECOVERY
        function initializeSessionPersistence() {
            console.log('üõ°Ô∏è Initializing session persistence measures...');
            
            // Backup family detection on page unload
            window.addEventListener('beforeunload', () => {
                const userEmail = localStorage.getItem('userEmail');
                if (userEmail) {
                    sessionStorage.setItem('backupEmail', userEmail);
                    console.log('üíæ Backed up user email before page unload');
                }
            });

            // Restore family detection on page load
            const userEmail = localStorage.getItem('userEmail') || sessionStorage.getItem('backupEmail');
            if (userEmail && !localStorage.getItem('userEmail')) {
                localStorage.setItem('userEmail', userEmail);
                console.log('üîÑ Restored user email from backup');
            }

            // Proactive session refresh every 50 minutes
            setInterval(async () => {
                try {
                    console.log('üîÑ Proactive session refresh check...');
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session) {
                        const expiresAt = session.expires_at;
                        const now = Math.floor(Date.now() / 1000);
                        const timeLeft = expiresAt - now;
                        
                        if (timeLeft < 600) { // Less than 10 minutes
                            console.log('‚è∞ Session expires soon - refreshing proactively');
                            const { error } = await supabase.auth.refreshSession();
                            if (error) {
                                console.error('‚ùå Proactive refresh failed:', error);
                            } else {
                                console.log('‚úÖ Session refreshed proactively');
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Proactive session check failed:', error);
                }
            }, 50 * 60 * 1000); // 50 minutes
        }

        // 2. ERROR BOUNDARIES AND GRACEFUL DEGRADATION
        function initializeErrorHandling() {
            console.log('üõ°Ô∏è Initializing error handling measures...');
            
            // Global error handler - log but don't crash
            window.addEventListener('error', (e) => {
                console.error('üí• Global error caught:', e.error);
                // Don't redirect on every error - just log it
                if (e.error?.message?.includes('auth') || e.error?.message?.includes('session')) {
                    console.log('üîç Auth-related error detected, checking session status...');
                    checkSessionHealth();
                } else {
                    console.log('üîß Non-auth error, continuing normally...');
                }
            });

            // Unhandled promise rejection handler
            window.addEventListener('unhandledrejection', (e) => {
                console.error('üí• Unhandled promise rejection:', e.reason);
                // Handle auth-related promise rejections gracefully
                if (e.reason?.message?.includes('auth') || e.reason?.message?.includes('JWT')) {
                    console.log('üîç Auth-related promise rejection, checking session...');
                    checkSessionHealth();
                }
                // Prevent the default behavior (which would show an error in console)
                e.preventDefault();
            });

            // Network error detection
            window.addEventListener('online', () => {
                console.log('üåê Network connection restored');
                // Refresh session when coming back online
                setTimeout(async () => {
                    try {
                        const { error } = await supabase.auth.refreshSession();
                        if (!error) {
                            console.log('‚úÖ Session refreshed after network restore');
                        }
                    } catch (refreshError) {
                        console.log('‚ö†Ô∏è Session refresh failed after network restore');
                    }
                }, 1000);
            });

            window.addEventListener('offline', () => {
                console.log('üì¥ Network connection lost - entering offline mode');
                // Store offline state to handle gracefully
                sessionStorage.setItem('offlineMode', 'true');
            });
        }

        // 3. SESSION HEALTH MONITORING
        async function checkSessionHealth() {
            try {
                console.log('üè• Checking session health...');
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.warn('‚ö†Ô∏è Session health check error:', error);
                    return false;
                }
                
                if (!session) {
                    console.log('‚ùå No active session found');
                    // Check if family member can continue without session
                    const storedEmail = localStorage.getItem('userEmail');
                    if (storedEmail && familyEmails.includes(storedEmail.toLowerCase())) {
                        console.log('üëë Family member - allowing continued access');
                        return true;
                    }
                    return false;
                }
                
                console.log('‚úÖ Session is healthy');
                return true;
            } catch (error) {
                console.error('‚ùå Session health check failed:', error);
                return false;
            }
        }

        // 4. BROWSER COMPATIBILITY FIXES
        function initializeBrowserCompatibility() {
            console.log('üõ°Ô∏è Initializing browser compatibility measures...');
            
            // Polyfill for older browsers
            if (!Array.prototype.includes) {
                Array.prototype.includes = function(searchElement) {
                    return this.indexOf(searchElement) !== -1;
                };
            }

            // Fix for Safari/iOS localStorage issues
            function testLocalStorage() {
                try {
                    const test = 'localStorage-test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    console.warn('‚ö†Ô∏è localStorage not available, using sessionStorage fallback');
                    return false;
                }
            }

            if (!testLocalStorage()) {
                // Fallback to sessionStorage for browsers that block localStorage
                window.localStorageFallback = {
                    getItem: (key) => sessionStorage.getItem(key),
                    setItem: (key, value) => sessionStorage.setItem(key, value),
                    removeItem: (key) => sessionStorage.removeItem(key)
                };
            }

            // Fix for touch events on mobile
            if ('ontouchstart' in window) {
                console.log('üì± Touch device detected - enabling touch optimizations');
                document.body.classList.add('touch-device');
                
                // Improve button touch responsiveness
                document.addEventListener('touchstart', function() {}, { passive: true });
            }

            // Fix for iOS viewport issues
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                console.log('üçé iOS device detected - applying iOS fixes');
                // Prevent zoom on input focus
                document.addEventListener('touchstart', function(e) {
                    if (e.target.tagName === 'INPUT') {
                        const viewport = document.querySelector('meta[name="viewport"]');
                        if (viewport) {
                            viewport.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
                            setTimeout(() => {
                                viewport.setAttribute('content', 'width=device-width, initial-scale=1');
                            }, 500);
                        }
                    }
                });
            }
        }

        // 5. DATA BACKUP AND RECOVERY
        function initializeDataBackup() {
            console.log('üõ°Ô∏è Initializing data backup measures...');
            
            // Backup AI configuration periodically
            setInterval(() => {
                try {
                    const aiConfig = sessionStorage.getItem('aiConfiguration');
                    if (aiConfig) {
                        localStorage.setItem('aiConfigBackup', aiConfig);
                        console.log('üíæ AI configuration backed up');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not backup AI configuration:', error);
                }
            }, 5 * 60 * 1000); // Every 5 minutes

            // Backup custom games
            const backupCustomGames = () => {
                try {
                    if (customGames.length > 0) {
                        localStorage.setItem('customGamesBackup', JSON.stringify(customGames));
                        localStorage.setItem('aiAnalysisBackup', JSON.stringify(aiAnalysisResults));
                        console.log('üíæ Custom games and AI analysis backed up');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not backup custom games:', error);
                }
            };

            // Backup when games are added/removed
            const originalAddGame = addCustomGame;
            const originalRemoveGame = removeCustomGame;
            
            // Override functions to include backup
            window.addCustomGame = async function() {
                await originalAddGame();
                backupCustomGames();
            };
            
            window.removeCustomGame = function(gameName) {
                originalRemoveGame(gameName);
                backupCustomGames();
            };

            // Restore from backup on page load
            try {
                const customGamesBackup = localStorage.getItem('customGamesBackup');
                const aiAnalysisBackup = localStorage.getItem('aiAnalysisBackup');
                
                if (customGamesBackup && customGames.length === 0) {
                    customGames = JSON.parse(customGamesBackup);
                    console.log('üîÑ Restored custom games from backup');
                }
                
                if (aiAnalysisBackup && Object.keys(aiAnalysisResults).length === 0) {
                    aiAnalysisResults = JSON.parse(aiAnalysisBackup);
                    console.log('üîÑ Restored AI analysis from backup');
                }
                
                if (customGames.length > 0) {
                    updateCustomGamesDisplay();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not restore from backup:', error);
            }
        }

        // 6. PERFORMANCE MONITORING
        function initializePerformanceMonitoring() {
            console.log('üõ°Ô∏è Initializing performance monitoring...');
            
            // Monitor page load performance
            window.addEventListener('load', () => {
                if (window.performance && window.performance.timing) {
                    const loadTime = window.performance.timing.loadEventEnd - window.performance.timing.navigationStart;
                    console.log(`üìä Page load time: ${loadTime}ms`);
                    
                    if (loadTime > 5000) {
                        console.warn('‚ö†Ô∏è Slow page load detected - this may affect user experience');
                    }
                }
            });

            // Monitor memory usage (if available)
            if (window.performance && window.performance.memory) {
                setInterval(() => {
                    const memory = window.performance.memory;
                    const usedMB = Math.round(memory.usedJSHeapSize / 1048576);
                    if (usedMB > 100) {
                        console.warn(`‚ö†Ô∏è High memory usage: ${usedMB}MB`);
                    }
                }, 60000); // Check every minute
            }
        }

        // 7. INITIALIZE ALL PREVENTATIVE MEASURES
        function initializePreventativeMeasures() {
            console.log('üõ°Ô∏è Starting preventative measures initialization...');
            
            try {
                initializeSessionPersistence();
                initializeErrorHandling();
                initializeBrowserCompatibility();
                initializeDataBackup();
                initializePerformanceMonitoring();
                
                console.log('‚úÖ All preventative measures initialized successfully');
                
                // Set flag to indicate measures are active
                sessionStorage.setItem('preventativeMeasuresActive', 'true');
                
            } catch (error) {
                console.error('‚ùå Error initializing preventative measures:', error);
                // Continue anyway - don't let preventative measures break the app
            }
        }

        // Initialize preventative measures when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePreventativeMeasures);
        } else {
            initializePreventativeMeasures();
        }
    </script>
</body>
</html>
