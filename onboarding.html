<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoStreamPro - Set Up Your Streams v2.25</title>
    <!-- onboarding.html Version 2.25: Fixed Twitter OAuth URL (Instagram & Twitch Protected) -->
    
    <!-- Facebook SDK -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId: '1369402897442291',
          cookie: true,
          xfbml: true,
          version: 'v18.0'
        });
      };
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .step-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .platform-card {
            transition: all 0.3s ease;
        }
        .platform-card:hover {
            transform: translateY(-2px);
        }
        .platform-card.connected {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .ai-tab {
            transition: all 0.3s ease;
        }
        .ai-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .game-option {
            transition: all 0.2s ease;
        }
        .game-option:hover {
            background-color: #f3f4f6;
        }
        .game-option.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">AutoStreamPro Setup</h1>
            <p class="text-blue-100">Let's get your streams connected and AI-powered!</p>
        </div>

        <!-- Progress Steps -->
        <div class="flex justify-center mb-8">
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-white text-blue-600 rounded-full flex items-center justify-center font-bold step-number" data-step="1">1</div>
                    <span class="ml-2 text-white font-medium step-text" data-step="1">Platforms</span>
                </div>
                <div class="w-8 h-1 bg-blue-300"></div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-300 text-blue-600 rounded-full flex items-center justify-center font-bold step-number" data-step="2">2</div>
                    <span class="ml-2 text-blue-200 font-medium step-text" data-step="2">AI Config</span>
                </div>
                <div class="w-8 h-1 bg-blue-300"></div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-300 text-blue-600 rounded-full flex items-center justify-center font-bold step-number" data-step="3">3</div>
                    <span class="ml-2 text-blue-200 font-medium step-text" data-step="3">Content</span>
                </div>
                <div class="w-8 h-1 bg-blue-300"></div>
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-300 text-blue-600 rounded-full flex items-center justify-center font-bold step-number" data-step="4">4</div>
                    <span class="ml-2 text-blue-200 font-medium step-text" data-step="4">Launch</span>
                </div>
            </div>
        </div>

        <!-- Step Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Step 1: Platform Connection -->
            <div id="step-1" class="step-content step-card rounded-xl p-8 shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Connect Your Platforms</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Twitch -->
                    <div class="platform-card border-2 border-gray-200 rounded-lg p-4" data-platform="twitch">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">T</span>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-800">Twitch</h3>
                                <p class="text-sm text-gray-600">Live streaming source</p>
                            </div>
                        </div>
                        <button onclick="connectTwitch()" class="connect-btn w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            Connect Twitch
                        </button>
                    </div>

                    <!-- YouTube -->
                    <div class="platform-card border-2 border-gray-200 rounded-lg p-4" data-platform="youtube">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">Y</span>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-800">YouTube</h3>
                                <p class="text-sm text-gray-600">Video publishing</p>
                            </div>
                        </div>
                        <button onclick="connectYoutube()" class="connect-btn w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors">
                            Connect YouTube
                        </button>
                    </div>

                    <!-- Instagram -->
                    <div class="platform-card border-2 border-gray-200 rounded-lg p-4" data-platform="instagram">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-pink-600 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">I</span>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-800">Instagram</h3>
                                <p class="text-sm text-gray-600">Short clips & reels</p>
                            </div>
                        </div>
                        <button onclick="connectInstagram()" class="connect-btn w-full bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 transition-colors">
                            Connect Instagram
                        </button>
                    </div>

                    <!-- TikTok -->
                    <div class="platform-card border-2 border-gray-200 rounded-lg p-4" data-platform="tiktok">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">T</span>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-800">TikTok</h3>
                                <p class="text-sm text-gray-600">Viral short videos</p>
                            </div>
                        </div>
                        <button class="connect-btn w-full bg-gray-400 text-white py-2 rounded-lg cursor-not-allowed">
                            <span class="text-orange-600">⏳</span> Coming Soon
                        </button>
                    </div>

                    <!-- Twitter/X -->
                    <div class="platform-card border-2 border-gray-200 rounded-lg p-4" data-platform="twitter">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                <span class="text-white font-bold">X</span>
                            </div>
                            <div class="ml-3">
                                <h3 class="font-semibold text-gray-800">Twitter/X</h3>
                                <p class="text-sm text-gray-600">Social engagement</p>
                            </div>
                        </div>
                        <button onclick="connectTwitter()" class="connect-btn w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Connect Twitter/X
                        </button>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button onclick="nextStep()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                        Continue to AI Configuration
                    </button>
                </div>
            </div>

            <!-- Step 2: AI Configuration -->
            <div id="step-2" class="step-content step-card rounded-xl p-8 shadow-2xl hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Configure AI Detection</h2>
                
                <!-- AI Tabs -->
                <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                    <button onclick="switchAITab('moments')" class="ai-tab flex-1 py-2 px-4 rounded-md font-medium transition-all active" data-tab="moments">
                        Moment Detection
                    </button>
                    <button onclick="switchAITab('games')" class="ai-tab flex-1 py-2 px-4 rounded-md font-medium transition-all" data-tab="games">
                        Game Selection
                    </button>
                    <button onclick="switchAITab('optimization')" class="ai-tab flex-1 py-2 px-4 rounded-md font-medium transition-all" data-tab="optimization">
                        Platform Optimization
                    </button>
                </div>

                <!-- Moment Detection Tab -->
                <div id="moments-tab" class="ai-tab-content">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-800">Detection Sensitivity</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="sensitivity" value="high" class="mr-2">
                                    <span>High - Catch every moment</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="sensitivity" value="medium" checked class="mr-2">
                                    <span>Medium - Balanced approach</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="sensitivity" value="low" class="mr-2">
                                    <span>Low - Only major highlights</span>
                                </label>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-800">Clip Length</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="clipLength" value="15" class="mr-2">
                                    <span>15 seconds - Quick hits</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="clipLength" value="30" checked class="mr-2">
                                    <span>30 seconds - Standard</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="clipLength" value="60" class="mr-2">
                                    <span>60 seconds - Extended</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Game Selection Tab -->
                <div id="games-tab" class="ai-tab-content hidden">
                    <p class="text-gray-600 mb-4">Select the games you primarily stream (helps AI understand context):</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="game-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer text-center" onclick="toggleGame(this)" data-game="valorant">
                            <div class="font-semibold">Valorant</div>
                        </div>
                        <div class="game-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer text-center" onclick="toggleGame(this)" data-game="fortnite">
                            <div class="font-semibold">Fortnite</div>
                        </div>
                        <div class="game-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer text-center" onclick="toggleGame(this)" data-game="apex">
                            <div class="font-semibold">Apex Legends</div>
                        </div>
                        <div class="game-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer text-center" onclick="toggleGame(this)" data-game="cod">
                            <div class="font-semibold">Call of Duty</div>
                        </div>
                        <div class="game-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer text-center" onclick="toggleGame(this)" data-game="lol">
                            <div class="font-semibold">League of Legends</div>
                        </div>
                        <div class="game-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer text-center" onclick="toggleGame(this)" data-game="minecraft">
                            <div class="font-semibold">Minecraft</div>
                        </div>
                        <div class="game-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer text-center" onclick="toggleGame(this)" data-game="gta">
                            <div class="font-semibold">GTA V</div>
                        </div>
                        <div class="game-option border-2 border-gray-200 rounded-lg p-3 cursor-pointer text-center" onclick="toggleGame(this)" data-game="other">
                            <div class="font-semibold">Other</div>
                        </div>
                    </div>
                </div>

                <!-- Platform Optimization Tab -->
                <div id="optimization-tab" class="ai-tab-content hidden">
                    <div class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3">YouTube Optimization</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span>Auto-generate titles with gaming keywords</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span>Create custom thumbnails with highlights</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2">
                                    <span>Schedule uploads for peak gaming hours</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3">Instagram/TikTok Optimization</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span>Vertical format optimization (9:16)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span>Add trending gaming hashtags</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2">
                                    <span>Auto-add captions for accessibility</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-3">Twitter/X Optimization</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span>Optimize video format for Twitter specs</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span>Auto-add gaming hashtags</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2">
                                    <span>Create tweet threads for longer content</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2">
                                    <span>Tag gaming communities/influencers</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors font-semibold">
                        Back
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                        Continue to Content Strategy
                    </button>
                </div>
            </div>

            <!-- Step 3: Content Strategy -->
            <div id="step-3" class="step-content step-card rounded-xl p-8 shadow-2xl hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Content Strategy</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-4">Publishing Schedule</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span>Auto-publish highlights immediately</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span>Review clips before publishing</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span>Schedule for optimal times</span>
                            </label>
                        </div>
                        
                        <h3 class="font-semibold text-gray-800 mb-4 mt-6">Content Types</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span>Epic moments & clutches</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2" checked>
                                <span>Funny fails & reactions</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span>Tutorial segments</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="mr-2">
                                <span>Community interactions</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-gray-800 mb-4">AI Voice & Tone</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="radio" name="tone" value="hype" checked class="mr-2">
                                <span>Hype & Energetic</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tone" value="chill" class="mr-2">
                                <span>Chill & Laid-back</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tone" value="competitive" class="mr-2">
                                <span>Competitive & Intense</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tone" value="educational" class="mr-2">
                                <span>Educational & Helpful</span>
                            </label>
                        </div>
                        
                        <h3 class="font-semibold text-gray-800 mb-4 mt-6">Branding</h3>
                        <div class="space-y-3">
                            <label class="block">
                                <span class="text-gray-700">Channel/Brand Name:</span>
                                <input type="text" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Your gaming brand">
                            </label>
                            <label class="block">
                                <span class="text-gray-700">Signature Style:</span>
                                <textarea class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2" rows="3" placeholder="Describe your unique gaming style..."></textarea>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors font-semibold">
                        Back
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                        Complete Setup
                    </button>
                </div>
            </div>

            <!-- Step 4: Launch -->
            <div id="step-4" class="step-content step-card rounded-xl p-8 shadow-2xl hidden text-center">
                <div class="mb-6">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-white text-2xl">✓</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">You're All Set!</h2>
                    <p class="text-gray-600">AutoStreamPro is now configured and ready to create viral clips from your streams.</p>
                </div>

                <div class="bg-blue-50 rounded-lg p-6 mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">What happens next?</h3>
                    <ul class="text-left space-y-2 text-gray-700">
                        <li>• AI will monitor your connected streams in real-time</li>
                        <li>• Highlight moments will be automatically detected</li>
                        <li>• Clips will be created and optimized for each platform</li>
                        <li>• Content will be published according to your preferences</li>
                    </ul>
                </div>

                <div class="space-y-4">
                    <button class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold w-full">
                        Go to Dashboard
                    </button>
                    <button onclick="restartSetup()" class="bg-gray-500 text-white px-8 py-3 rounded-lg hover:bg-gray-600 transition-colors font-semibold w-full">
                        Restart Setup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase initialization
        const supabaseUrl = 'https://ksgehuprwrqvmmdngjoj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzZ2VodXByd3Jxdm1tZG5nam9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQyMzQxMDYsImV4cCI6MjA0OTgxMDEwNn0.Qr8aaP2VfHYQDHo7FMp6KWs6Jd0-U3y6F4HzKpWqJeI';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentStep = 1;
        let selectedGames = [];
        let connectedPlatforms = [];

        // OAuth Configuration
        const twitchClientId = 'mzjsqcwxj9mexsa8vaimtzanbe7pll';
        const youtubeClientId = '17381198225-gn5qnqdlhuehbhlva9ro046r5qbssfrn.apps.googleusercontent.com';
        const twitterClientId = 'WEdRcTBfd1c0QTN6eEk1ZHo4OWY6MTpjaQ';

        // Platform connection functions
        function connectTwitch() {
            console.log('Connecting to Twitch...');
            
            const twitchAuthUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${twitchClientId}&redirect_uri=https://autostreampro.com/onboarding.html&response_type=code&scope=user:read:email+clips:edit&state=twitch`;
            window.location.href = twitchAuthUrl;
        }

        function connectYoutube() {
    console.log('YouTube clicked');
    console.log('Client ID:', youtubeClientId);
    
    var youtubeUrl = 'https://accounts.google.com/o/oauth2/v2/auth?client_id=' + youtubeClientId + '&redirect_uri=https://autostreampro.com/auth/youtube.html&response_type=code&scope=https://www.googleapis.com/auth/youtube.upload+https://www.googleapis.com/auth/youtube.readonly&access_type=offline';
    
    window.open(youtubeUrl, 'youtube_auth', 'width=600,height=600');
    
    alert('YouTube OAuth popup opened!');
}

        function connectTwitter() {
    console.log('Connecting to Twitter/X...');
    
    // Use popup approach like Instagram to avoid CSP issues
    const twitterAuthUrl = `https://twitter.com/i/oauth2/authorize?response_type=code&client_id=${twitterClientId}&redirect_uri=https://autostreampro.com/auth/twitter.html&scope=users.read%20tweet.read%20offline.access&state=twitter`;
    
    // Open popup like Instagram does
    const popup = window.open(
        twitterAuthUrl,
        'twitter_auth',
        'width=600,height=600,scrollbars=yes,resizable=yes'
    );
    
    // Monitor popup like Instagram pattern
    const checkClosed = setInterval(() => {
        if (popup.closed) {
            clearInterval(checkClosed);
            
            // Mark as connected (same as Instagram approach)
            document.querySelector('[data-platform="twitter"] .connect-btn').innerHTML = 
                '<span class="text-green-600">✓</span> Connected';
            document.querySelector('[data-platform="twitter"]').classList.add('connected');
            
            if (!connectedPlatforms.includes('twitter')) {
                connectedPlatforms.push('twitter');
            }
            
            console.log('Twitter connection attempt completed');
        }
    }, 1000);
}

        function connectInstagram() {
            console.log('Instagram connect clicked');
            
            // Check if Facebook SDK is loaded
            if (typeof FB === 'undefined') {
                console.error('Facebook SDK not loaded - trying to load...');
                
                // Try to reload Facebook SDK
                loadFacebookSDK().then(() => {
                    console.log('Facebook SDK loaded, retrying Instagram connection');
                    connectInstagramWithSDK();
                }).catch(() => {
                    alert('Instagram connection unavailable. Please disable ad blockers and try again.');
                });
                return;
            }
            
            connectInstagramWithSDK();
        }
        
        function connectInstagramWithSDK() {
            console.log('Attempting Instagram connection with Facebook SDK');
            
            FB.login(function(response) {
                console.log('Facebook login response:', response);
                
                if (response.authResponse) {
                    console.log('Instagram connected successfully');
                    console.log('Access token:', response.authResponse.accessToken);
                    
                    // Save to Supabase
                    savePlatformConnection('instagram', {
                        accessToken: response.authResponse.accessToken,
                        userID: response.authResponse.userID,
                        expiresIn: response.authResponse.expiresIn
                    });
                    
                    // Update UI
                    document.querySelector('[data-platform="instagram"] .connect-btn').innerHTML = 
                        '<span class="text-green-600">✓</span> Connected';
                    document.querySelector('[data-platform="instagram"]').classList.add('connected');
                } else {
                    console.log('Instagram connection cancelled or failed:', response);
                    alert('Instagram connection failed. Please try again.');
                }
            }, {scope: 'email,pages_show_list,pages_read_engagement'});
        }
        
        function loadFacebookSDK() {
            return new Promise((resolve, reject) => {
                if (typeof FB !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://connect.facebook.net/en_US/sdk.js';
                script.onload = () => {
                    FB.init({
                        appId: '1369402897442291',
                        cookie: true,
                        xfbml: true,
                        version: 'v18.0'
                    });
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Save platform connection via serverless function (bypasses CSP)
        async function savePlatformConnection(platform, authData) {
            try {
                const response = await fetch('/.netlify/functions/save-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ platform, authData })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('Platform connection saved:', result.data);
                    connectedPlatforms.push(platform);
                } else {
                    console.error('Error saving platform connection:', result.error);
                }
            } catch (error) {
                console.error('Error saving platform connection:', error);
            }
        }

        // Check if platform connections exist
        async function checkPlatformConnections() {
            try {
                const { data, error } = await supabase
                    .from('platform_connections')
                    .select('platform')
                    .eq('user_id', 'test-user');

                if (error) {
                    console.error('Error checking platform connections:', error);
                    return;
                }

                if (data) {
                    data.forEach(connection => {
                        const platformElement = document.querySelector(`[data-platform="${connection.platform}"]`);
                        if (platformElement) {
                            const button = platformElement.querySelector('.connect-btn');
                            button.innerHTML = '<span class="text-green-600">✓</span> Connected';
                            platformElement.classList.add('connected');
                            connectedPlatforms.push(connection.platform);
                        }
                    });
                }
            } catch (error) {
                console.error('Error checking platform connections:', error);
            }
        }

        // Step navigation
        function nextStep() {
            if (currentStep < 4) {
                // Hide current step
                document.getElementById(`step-${currentStep}`).classList.add('hidden');
                
                // Update progress
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('bg-white', 'text-blue-600');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('bg-blue-600', 'text-white');
                document.querySelector(`[data-step="${currentStep}"].step-text`).classList.remove('text-white');
                document.querySelector(`[data-step="${currentStep}"].step-text`).classList.add('text-blue-200');
                
                currentStep++;
                
                // Show next step
                document.getElementById(`step-${currentStep}`).classList.remove('hidden');
                
                // Update progress
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('bg-blue-300', 'text-blue-600');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('bg-white', 'text-blue-600');
                document.querySelector(`[data-step="${currentStep}"].step-text`).classList.remove('text-blue-200');
                document.querySelector(`[data-step="${currentStep}"].step-text`).classList.add('text-white');
                
                // Save configuration if moving to final step
                if (currentStep === 4) {
                    saveConfiguration();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                // Hide current step
                document.getElementById(`step-${currentStep}`).classList.add('hidden');
                
                // Update progress
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('bg-white', 'text-blue-600');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('bg-blue-300', 'text-blue-600');
                document.querySelector(`[data-step="${currentStep}"].step-text`).classList.remove('text-white');
                document.querySelector(`[data-step="${currentStep}"].step-text`).classList.add('text-blue-200');
                
                currentStep--;
                
                // Show previous step
                document.getElementById(`step-${currentStep}`).classList.remove('hidden');
                
                // Update progress
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('bg-blue-600', 'text-white');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('bg-white', 'text-blue-600');
                document.querySelector(`[data-step="${currentStep}"].step-text`).classList.remove('text-blue-200');
                document.querySelector(`[data-step="${currentStep}"].step-text`).classList.add('text-white');
            }
        }

        function restartSetup() {
            currentStep = 1;
            
            // Hide all steps except first
            for (let i = 2; i <= 4; i++) {
                document.getElementById(`step-${i}`).classList.add('hidden');
            }
            document.getElementById('step-1').classList.remove('hidden');
            
            // Reset progress indicators
            for (let i = 1; i <= 4; i++) {
                const stepNumber = document.querySelector(`[data-step="${i}"].step-number`);
                const stepText = document.querySelector(`[data-step="${i}"].step-text`);
                
                if (i === 1) {
                    stepNumber.classList.add('bg-white', 'text-blue-600');
                    stepNumber.classList.remove('bg-blue-300', 'bg-blue-600', 'text-white');
                    stepText.classList.add('text-white');
                    stepText.classList.remove('text-blue-200');
                } else {
                    stepNumber.classList.add('bg-blue-300', 'text-blue-600');
                    stepNumber.classList.remove('bg-white', 'bg-blue-600', 'text-white');
                    stepText.classList.add('text-blue-200');
                    stepText.classList.remove('text-white');
                }
            }
        }

        // AI Configuration
        function switchAITab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.ai-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            // Add active class to selected tab
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        function toggleGame(element) {
            const game = element.dataset.game;
            
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedGames = selectedGames.filter(g => g !== game);
            } else {
                element.classList.add('selected');
                selectedGames.push(game);
            }
        }

        // Save configuration
        async function saveConfiguration() {
            const config = {
                user_id: 'test-user',
                sensitivity: document.querySelector('input[name="sensitivity"]:checked').value,
                clip_length: parseInt(document.querySelector('input[name="clipLength"]:checked').value),
                selected_games: selectedGames,
                tone: document.querySelector('input[name="tone"]:checked').value,
                connected_platforms: connectedPlatforms,
                created_at: new Date()
            };

            try {
                const { data, error } = await supabase
                    .from('user_configurations')
                    .upsert(config);

                if (error) {
                    console.error('Error saving configuration:', error);
                } else {
                    console.log('Configuration saved:', data);
                }
            } catch (error) {
                console.error('Error saving configuration:', error);
            }
        }

        // Check for OAuth return and handle tokens
        function handleOAuthReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            if (error) {
                console.error('OAuth error:', error);
                alert(`Connection failed: ${error}`);
                return;
            }
            
            if (code) {
                console.log('OAuth code received:', code, 'State:', state);
                
                if (state === 'twitch') {
                    console.log('Handling Twitch OAuth return');
                    // Directly mark as connected for now (skip token exchange)
                    document.querySelector('[data-platform="twitch"] .connect-btn').innerHTML = 
                        '<span class="text-green-600">✓</span> Connected';
                    document.querySelector('[data-platform="twitch"]').classList.add('connected');
                    
                    // Save to connected platforms
                    if (!connectedPlatforms.includes('twitch')) {
                        connectedPlatforms.push('twitch');
                    }
                } else if (state === 'twitter') {
                    console.log('Handling Twitter OAuth return');
                    // Directly mark as connected for now (skip token exchange)
                    document.querySelector('[data-platform="twitter"] .connect-btn').innerHTML = 
                        '<span class="text-green-600">✓</span> Connected';
                    document.querySelector('[data-platform="twitter"]').classList.add('connected');
                    
                    // Save to connected platforms
                    if (!connectedPlatforms.includes('twitter')) {
                        connectedPlatforms.push('twitter');
                    }
                } else if (document.referrer.includes('google') || document.referrer.includes('youtube')) {
                    console.log('Handling YouTube OAuth return');
                    exchangeCodeForTokens('youtube', code);
                }
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function exchangeCodeForTokens(platform, code) {
            try {
                const response = await fetch(`/.netlify/functions/oauth-${platform}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();
                
                if (data.access_token) {
                    console.log(`${platform} tokens received:`, data);
                    
                    // Save to Supabase
                    await savePlatformConnection(platform, {
                        accessToken: data.access_token,
                        refreshToken: data.refresh_token,
                        expiresIn: data.expires_in
                    });
                    
                    // Update UI
                    const platformElement = document.querySelector(`[data-platform="${platform}"]`);
                    if (platformElement) {
                        const button = platformElement.querySelector('.connect-btn');
                        button.innerHTML = '<span class="text-green-600">✓</span> Connected';
                        platformElement.classList.add('connected');
                    }
                } else {
                    console.error(`Failed to exchange ${platform} code:`, data);
                }
            } catch (error) {
                console.error(`Error exchanging ${platform} code:`, error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded');
            checkPlatformConnections();
            handleOAuthReturn();
        });
    </script>
</body>
</html>
