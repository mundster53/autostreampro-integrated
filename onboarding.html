<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoStreamPro - Set Up Your Streams</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .nav-links {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .family-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .step-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            background: #4CAF50;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .platform-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .platform-card:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
        }

        .platform-card.connected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .platform-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .platform-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .platform-status {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .connect-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .connected-btn {
            background: #4CAF50;
            cursor: default;
        }

        .credentials-form {
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .save-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            height: 100%;
            transition: width 0.3s ease;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: white;
                text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow: .25em 0 0 white, .5em 0 0 white;
            }
        }

        .hidden {
            display: none;
        }

        .next-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="navLinks" class="nav-links hidden">
                <button class="nav-btn" data-action="dashboard">üìä Dashboard</button>
                <button id="adminBtn" class="nav-btn hidden" data-action="admin">‚öôÔ∏è Admin</button>
            </div>
            <h1>üéÆ AutoStreamPro Setup</h1>
            <p>Connect your gaming platforms and start automated streaming</p>
            <div id="familyBadge" class="family-badge hidden">
                üëë Family Member - Lifetime Pro Access
            </div>
        </div>

        <div id="loadingScreen" class="loading">
            Initializing your AutoStreamPro experience
        </div>

        <div id="mainContent" class="hidden">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 25%"></div>
            </div>

            <!-- Step 1: Connect Gaming Platforms -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Connect Your Gaming Platforms</div>
                </div>
                
                <div class="platform-grid">
                    <div class="platform-card" data-platform="twitch">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a855f7'%3E%3Cpath d='M2.149 0L.537 4.119v15.823h5.731V24h3.224l4.058-4.058h6.135L24 15.725V0H2.149zm19.164 14.569l-3.506 3.506h-5.731l-3.224 3.224v-3.224H5.043V2.687h16.27v11.882z'/%3E%3Cpath d='M18.464 7.334v4.746h-2.149V7.334h2.149zm-5.731 0v4.746h-2.149V7.334h2.149z'/%3E%3C/svg%3E" alt="Twitch" class="platform-icon">
                        <div class="platform-name">Twitch</div>
                        <div class="platform-status">Not connected</div>
                        <button class="connect-btn" data-platform="twitch">Connect Twitch</button>
                    </div>

                    <div class="platform-card" data-platform="youtube">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff0000'%3E%3Cpath d='M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z'/%3E%3C/svg%3E" alt="YouTube" class="platform-icon">
                        <div class="platform-name">YouTube</div>
                        <div class="platform-status">Not connected</div>
                        <button class="connect-btn" data-platform="youtube">Connect YouTube</button>
                    </div>

                    <div class="platform-card" data-platform="instagram">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e4405f'%3E%3Cpath d='M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z'/%3E%3C/svg%3E" alt="Instagram" class="platform-icon">
                        <div class="platform-name">Instagram</div>
                        <div class="platform-status">Not connected</div>
                        <button class="connect-btn" data-platform="instagram">Connect Instagram</button>
                    </div>

                    <div class="platform-card" data-platform="tiktok">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23000000'%3E%3Cpath d='M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z'/%3E%3C/svg%3E" alt="TikTok" class="platform-icon">
                        <div class="platform-name">TikTok</div>
                        <div class="platform-status">Not connected</div>
                        <button class="connect-btn" data-platform="tiktok">Connect TikTok</button>
                    </div>
                </div>

                <div id="credentialsSection" class="hidden">
                    <h3 style="margin: 30px 0 20px 0;">Enter Your Platform Credentials</h3>
                    <div id="credentialsForms"></div>
                </div>
            </div>

            <!-- Step 2: AI Configuration -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Configure AI Settings</div>
                </div>
                <p>Set up your AI preferences for automated content creation and engagement.</p>
                <button class="next-btn" data-action="next-step">Configure AI Settings</button>
            </div>

            <!-- Step 3: Content Strategy -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Content Strategy</div>
                </div>
                <p>Define your content goals and automated posting schedule.</p>
                <button class="next-btn" data-action="next-step">Set Content Strategy</button>
            </div>

            <!-- Step 4: Launch -->
            <div class="step-container">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Launch AutoStreamPro</div>
                </div>
                <p>You're all set! Start your automated streaming journey.</p>
                <button class="next-btn" data-action="launch">üöÄ Launch My Automated Streams</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://dykxhmdozgccawkbxejd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5a3hobWRvemdjY2F3a2J4ZWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY3MjI2MzAsImV4cCI6MjA1MjI5ODYzMH0.cprEG_vE1fzjGvAA87ZCCHnyGUIgHwXhqsOyoXGDLII';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Family member emails
        const familyEmails = [
            'mundt53@gmail.com',
            'duncanmundt1@gmail.com', 
            'mundstermom@gmail.com',
            'ChristianMundt95@gmail.com',
            'jordanmundt1@gmail.com',
            'julia.elaine.lee@gmail.com'
        ];

        let connectedPlatforms = [];
        let userIsFamilyMember = false;

        // Check if current user is family member
        async function isFamilyMember() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session && session.user) {
                    return familyEmails.includes(session.user.email.toLowerCase());
                }
                return false;
            } catch (error) {
                console.error('Error checking family status:', error);
                return false;
            }
        }

        // Initialize the application
        async function initializeApp() {
            try {
                console.log('üöÄ Starting AutoStreamPro onboarding initialization...');
                
                // Check if Supabase is loaded
                if (!window.supabase) {
                    throw new Error('Supabase library not loaded');
                }
                
                console.log('‚úÖ Supabase library loaded');
                
                // Check if user is authenticated
                console.log('üîç Checking user authentication...');
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('‚ùå Session error:', sessionError);
                    throw sessionError;
                }
                
                if (!session) {
                    console.log('‚ùå No session found, redirecting to signup...');
                    window.location.href = '/signup.html';
                    return;
                }
                
                console.log('‚úÖ User authenticated:', session.user.email);

                // Check if user is family member
                console.log('üëë Checking family member status...');
                userIsFamilyMember = await isFamilyMember();
                console.log('Family member status:', userIsFamilyMember);

                if (userIsFamilyMember) {
                    // Family member - show family badge and skip payment checks
                    document.getElementById('familyBadge').classList.remove('hidden');
                    document.getElementById('adminBtn').classList.remove('hidden');
                    console.log('üëë Family member detected - bypassing payment checks');
                } else {
                    // Regular user - check subscription status
                    console.log('üí≥ Checking subscription status...');
                    const hasValidSubscription = await checkSubscriptionStatus();
                    if (!hasValidSubscription) {
                        console.log('‚ùå No valid subscription, redirecting to signup...');
                        window.location.href = '/signup.html';
                        return;
                    }
                    console.log('‚úÖ Valid subscription found');
                }

                // Show navigation links
                document.getElementById('navLinks').classList.remove('hidden');

                // Load existing credentials if any
                console.log('üìã Loading existing credentials...');
                await loadExistingCredentials();

                // Show main content
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                console.log('üéâ Onboarding initialized successfully!');
                
            } catch (error) {
                console.error('üí• Error initializing app:', error);
                
                // Show error message to user
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.innerHTML = `
                    <div style="color: #ff6b6b; text-align: center;">
                        <h3>‚ö†Ô∏è Initialization Error</h3>
                        <p>There was a problem loading AutoStreamPro.</p>
                        <p style="font-size: 0.9rem; opacity: 0.8;">Error: ${error.message}</p>
                        <button data-action="retry" style="margin-top: 20px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
                
                // If not family member and error occurs, redirect to signup as fallback
                if (!userIsFamilyMember) {
                    setTimeout(() => {
                        window.location.href = '/signup.html';
                    }, 5000);
                }
            }
        }

        // Load existing credentials
        async function loadExistingCredentials() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const { data: credentials, error } = await supabase
                    .from('user_platform_credentials')
                    .select('platform, username')
                    .eq('user_id', session.user.id);

                if (error) {
                    console.error('Error loading credentials:', error);
                    return;
                }

                credentials.forEach(cred => {
                    const platform = cred.platform;
                    const card = document.querySelector(`[data-platform="${platform}"]`);
                    const button = card.querySelector('.connect-btn');
                    const status = card.querySelector('.platform-status');
                    
                    // Mark as connected
                    card.classList.add('connected');
                    button.classList.add('connected-btn');
                    button.textContent = '‚úì Connected';
                    status.textContent = `Connected as ${cred.username}`;
                    connectedPlatforms.push(platform);
                    
                    // Show existing credentials with edit option
                    showExistingCredentials(platform, cred.username);
                });

                updateProgress();

            } catch (error) {
                console.error('Error loading existing credentials:', error);
            }
        }

        // Show existing credentials with edit option
        function showExistingCredentials(platform, username) {
            const credentialsSection = document.getElementById('credentialsSection');
            const credentialsForms = document.getElementById('credentialsForms');
            
            credentialsSection.classList.remove('hidden');
            
            const formHTML = `
                <div class="credentials-form" id="${platform}-credentials">
                    <div class="success-message">
                        ‚úÖ ${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials configured!
                        <br><strong>Username:</strong> ${username}
                        <br><br>
                        <button class="save-btn" data-action="edit-credentials" data-platform="${platform}" data-username="${username}">Edit Credentials</button>
                    </div>
                </div>
            `;
            
            credentialsForms.innerHTML += formHTML;
        }

        // Check subscription status for regular users
        async function checkSubscriptionStatus() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return false;

                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('subscription_status, subscription_plan, is_family_member')
                    .eq('user_id', session.user.id)
                    .single();

                if (!profile) return false;

                // Check if user has active subscription or is family member
                return profile.subscription_status === 'active' || 
                       profile.is_family_member === true ||
                       profile.subscription_plan === 'pro';
                       
            } catch (error) {
                console.error('Error checking subscription:', error);
                return false;
            }
        }

        // Connect platform function
        async function connectPlatform(platform) {
            const card = document.querySelector(`[data-platform="${platform}"]`);
            const button = card.querySelector('.connect-btn');
            const status = card.querySelector('.platform-status');
            
            // Simulate connection process
            button.disabled = true;
            button.textContent = 'Connecting...';
            status.textContent = 'Connecting...';
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Mark as connected
            card.classList.add('connected');
            button.classList.add('connected-btn');
            button.textContent = '‚úì Connected';
            status.textContent = 'Connected successfully';
            connectedPlatforms.push(platform);
            
            // Show credentials form
            showCredentialsForm(platform);
            
            // Update progress
            updateProgress();
        }

        // Show credentials form for platform
        function showCredentialsForm(platform) {
            const credentialsSection = document.getElementById('credentialsSection');
            const credentialsForms = document.getElementById('credentialsForms');
            
            credentialsSection.classList.remove('hidden');
            
            const formHTML = `
                <div class="credentials-form" id="${platform}-credentials">
                    <h4>${platform.charAt(0).toUpperCase() + platform.slice(1)} Credentials</h4>
                    <div class="form-group">
                        <label for="${platform}-username">Username/Channel Name:</label>
                        <input type="text" id="${platform}-username" placeholder="Enter your ${platform} username">
                    </div>
                    <div class="form-group">
                        <label for="${platform}-token">API Token/Key:</label>
                        <input type="password" id="${platform}-token" placeholder="Enter your ${platform} API token">
                    </div>
                    <button class="save-btn" data-action="save-credentials" data-platform="${platform}">Save ${platform} Credentials</button>
                </div>
            `;
            
            credentialsForms.innerHTML += formHTML;
        }

        // Save credentials for platform
        async function saveCredentials(platform) {
            const username = document.getElementById(`${platform}-username`).value;
            const token = document.getElementById(`${platform}-token`).value;
            
            if (!username || !token) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;
                
                // Save credentials to database (in a real app, encrypt these!)
                const { error } = await supabase
                    .from('user_platform_credentials')
                    .upsert({
                        user_id: session.user.id,
                        platform: platform,
                        username: username,
                        encrypted_token: token, // Should be encrypted in production
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                // Show success message with edit option
                const form = document.getElementById(`${platform}-credentials`);
                form.innerHTML = `
                    <div class="success-message">
                        ‚úÖ ${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials saved successfully!
                        <br><br>
                        <button class="save-btn" data-action="edit-credentials" data-platform="${platform}" data-username="${username}">Edit Credentials</button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error saving credentials:', error);
                alert('Failed to save credentials. Please try again.');
            }
        }

        // Edit existing credentials
        function editCredentials(platform, currentUsername) {
            const form = document.getElementById(`${platform}-credentials`);
            form.innerHTML = `
                <h4>Edit ${platform.charAt(0).toUpperCase() + platform.slice(1)} Credentials</h4>
                <div class="form-group">
                    <label for="${platform}-username-edit">Username/Channel Name:</label>
                    <input type="text" id="${platform}-username-edit" value="${currentUsername}" placeholder="Enter your ${platform} username">
                </div>
                <div class="form-group">
                    <label for="${platform}-token-edit">API Token/Key:</label>
                    <input type="password" id="${platform}-token-edit" placeholder="Enter your ${platform} API token">
                </div>
                <button class="save-btn" data-action="update-credentials" data-platform="${platform}">Update ${platform} Credentials</button>
                <button class="save-btn" style="background: #666; margin-left: 10px;" data-action="cancel-edit" data-platform="${platform}" data-username="${currentUsername}">Cancel</button>
            `;
        }

        // Update credentials
        async function updateCredentials(platform) {
            const username = document.getElementById(`${platform}-username-edit`).value;
            const token = document.getElementById(`${platform}-token-edit`).value;
            
            if (!username || !token) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;
                
                // Update credentials in database
                const { error } = await supabase
                    .from('user_platform_credentials')
                    .upsert({
                        user_id: session.user.id,
                        platform: platform,
                        username: username,
                        encrypted_token: token,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                // Show success message
                const form = document.getElementById(`${platform}-credentials`);
                form.innerHTML = `
                    <div class="success-message">
                        ‚úÖ ${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials updated successfully!
                        <br><br>
                        <button class="save-btn" data-action="edit-credentials" data-platform="${platform}" data-username="${username}">Edit Credentials</button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error updating credentials:', error);
                alert('Failed to update credentials. Please try again.');
            }
        }

        // Cancel credential editing
        function cancelEdit(platform, originalUsername) {
            const form = document.getElementById(`${platform}-credentials`);
            form.innerHTML = `
                <div class="success-message">
                    ‚úÖ ${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials saved successfully!
                    <br><br>
                    <button class="save-btn" data-action="edit-credentials" data-platform="${platform}" data-username="${originalUsername}">Edit Credentials</button>
                </div>
            `;
        }

        // Update progress bar
        function updateProgress() {
            const totalSteps = 4;
            const completedPlatforms = connectedPlatforms.length;
            const progressPercent = Math.min(25 + (completedPlatforms * 15), 100);
            
            document.getElementById('progressFill').style.width = progressPercent + '%';
        }

        // Next step function
        function nextStep() {
            // In a real implementation, this would navigate to the next configuration step
            alert('This feature is coming soon! Your platform connections are being saved.');
        }

        // Launch platform function
        function launchPlatform() {
            if (connectedPlatforms.length === 0) {
                alert('Please connect at least one platform before launching.');
                return;
            }
            
            // Show success message and redirect to dashboard
            const confirmed = confirm(`üéâ Congratulations! You've successfully set up AutoStreamPro with ${connectedPlatforms.length} platform(s).\n\nClick OK to go to your dashboard where you can:\n‚Ä¢ Monitor your automated streams\n‚Ä¢ View analytics\n‚Ä¢ Manage content\n‚Ä¢ Update settings\n\nYou can always return here to add more platforms or edit credentials.`);
            
            if (confirmed) {
                // Redirect to main dashboard
                window.location.href = '/dashboard.html';
            }
        }

        // Quick navigation functions
        function goToDashboard() {
            window.location.href = '/dashboard.html';
        }

        function goToAdmin() {
            if (userIsFamilyMember) {
                window.location.href = '/admin.html';
            } else {
                alert('Admin access is only available for family members.');
            }
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app
            initializeApp();
            
            // Set up event listeners for all buttons
            setupEventListeners();
        });

        // Set up all event listeners to replace onclick handlers
        function setupEventListeners() {
            // Handle all button clicks using event delegation
            document.addEventListener('click', function(e) {
                const target = e.target;
                const action = target.dataset.action;
                const platform = target.dataset.platform;
                
                if (!action) return;
                
                switch(action) {
                    case 'dashboard':
                        goToDashboard();
                        break;
                    case 'admin':
                        goToAdmin();
                        break;
                    case 'next-step':
                        nextStep();
                        break;
                    case 'launch':
                        launchPlatform();
                        break;
                    case 'retry':
                        location.reload();
                        break;
                    case 'save-credentials':
                        if (platform) saveCredentials(platform);
                        break;
                    case 'edit-credentials':
                        if (platform) {
                            const username = target.dataset.username;
                            editCredentials(platform, username);
                        }
                        break;
                    case 'update-credentials':
                        if (platform) updateCredentials(platform);
                        break;
                    case 'cancel-edit':
                        if (platform) {
                            const username = target.dataset.username;
                            cancelEdit(platform, username);
                        }
                        break;
                }
            });
            
            // Handle platform connection buttons
            document.addEventListener('click', function(e) {
                const target = e.target;
                if (target.classList.contains('connect-btn') && target.dataset.platform) {
                    const platform = target.dataset.platform;
                    connectPlatform(platform);
                }
            });
        }

        // Handle auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = '/signup.html';
            }
        });
    </script>
</body>
</html>
