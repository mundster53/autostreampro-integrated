// ==================================================
// ADD THIS RIGHT AFTER LINE 461 (after supabase initialization)
// ==================================================

// Family member emails - ADD THIS
const familyEmails = [
    'mundt53@gmail.com',
    'duncanmundt1@gmail.com', 
    'mundstermom@gmail.com',
    'ChristianMundt95@gmail.com',
    'jordanmundt1@gmail.com',
    'julia.elaine.lee@gmail.com'
];

// ==================================================
// REPLACE YOUR handleSignup FUNCTION (starting around line 550)
// WITH THIS VERSION THAT INCLUDES FAMILY DETECTION:
// ==================================================

// Handle form submission
async function handleSignup(e) {
    e.preventDefault();
    console.log('üöÄ Form submitted');
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const btn = document.getElementById('signup-btn');
    
    console.log(`üìä Data: email=${email}, password=${password.length} chars, plan=${selectedPlan}`);
    
    // Clear previous messages
    clearMessages();
    
    // Basic validation
    if (!email || !password) {
        showError('form-message', 'Please enter both email and password');
        return;
    }
    
    if (!isValidEmail(email)) {
        showError('email-error', 'Please enter a valid email address');
        return;
    }
    
    if (password.length < 6) {
        showError('password-error', 'Password must be at least 6 characters');
        return;
    }
    
    // Check Supabase
    if (!supabase) {
        showError('form-message', 'Please configure Supabase credentials to continue');
        return;
    }
    
    // Show loading
    btn.disabled = true;
    btn.textContent = 'Creating Account...';
    
    try {
        console.log('üîÑ Creating Supabase account...');
        
        // Family detection
        const isFamily = familyEmails.includes(email.toLowerCase());
        
        if (isFamily) {
            console.log('üëë Family member detected - creating free account');
            
            // Create Supabase auth account
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email: email,
                password: password
            });
            
            if (authError) throw authError;
            console.log('‚úÖ Family auth account created');
            
            // Create family member profile
            const { error: profileError } = await supabase
                .from('user_profiles')
                .upsert({
                    user_id: authData.user.id,
                    email: email,
                    is_family_member: true,
                    subscription_status: 'active',
                    subscription_plan: 'pro',
                    subscription_type: 'lifetime',
                    access_level: 'family_admin'
                });
            
            if (profileError) throw profileError;
            console.log('‚úÖ Family profile created');
            
            showSuccess('form-message', 'üéâ Welcome to the family! You have lifetime Pro access.');
            
            setTimeout(() => {
                window.location.href = '/dashboard.html';
            }, 2000);
            return;
        }
        
        // Regular user - existing code
        console.log('üí≥ Regular user - processing normally');
        
        // Create account
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    plan: selectedPlan,
                    price: selectedPrice
                }
            }
        });
        
        if (error) {
            throw error;
        }
        
        if (!data.user) {
            throw new Error('Account creation failed');
        }
        
        console.log('‚úÖ Account created:', data.user.id);
        
        // Store for Stripe
        sessionStorage.setItem('userEmail', email);
        sessionStorage.setItem('userId', data.user.id);
        sessionStorage.setItem('selectedPlan', selectedPlan);
        sessionStorage.setItem('selectedPrice', selectedPrice);
        
        showSuccess('form-message', 'Account created! Setting up payment...');
        
        // Create Stripe checkout
        await createStripeCheckout(data.user);
        
    } catch (error) {
        console.error('‚ùå Signup failed:', error);
        handleSignupError(error);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Start Free Trial ‚Üí';
    }
}
    
    // Basic validation
    if (!email || !password) {
        showError('form-message', 'Please enter both email and password');
        return;
    }
    
    if (!isValidEmail(email)) {
        showError('email-error', 'Please enter a valid email address');
        return;
    }
    
    if (password.length < 6) {
        showError('password-error', 'Password must be at least 6 characters');
        return;
    }
    
    // Check Supabase
    if (!supabase) {
        showError('form-message', 'Please configure Supabase credentials to continue');
        return;
    }
    
    // Show loading
    btn.disabled = true;
    btn.textContent = 'Creating Account...';
    
    try {
        console.log('üîÑ Creating Supabase account...');
        
        // Family member emails
const familyEmails = [
    'mundt53@gmail.com',
    'duncanmundt1@gmail.com', 
    'mundstermom@gmail.com',
    'ChristianMundt95@gmail.com',
    'jordanmundt1@gmail.com',
    'julia.elaine.lee@gmail.com'
];
    
    if (isFamily) {
        console.log('üëë Family member detected');
        showSuccess('form-message', 'üéâ Welcome to the family! You have lifetime Pro access.');
        setTimeout(() => window.location.href = '/dashboard.html', 2000);
        return;
    }
        
        // Regular user - YOUR EXISTING CODE CONTINUES UNCHANGED
        console.log('üí≥ Regular user - processing normally');
        
        // Create account
        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    plan: selectedPlan,
                    price: selectedPrice
                }
            }
        });
        
        if (error) {
            throw error;
        }
        
        if (!data.user) {
            throw new Error('Account creation failed');
        }
        
        console.log('‚úÖ Account created:', data.user.id);
        
        // Store for Stripe
        sessionStorage.setItem('userEmail', email);
        sessionStorage.setItem('userId', data.user.id);
        sessionStorage.setItem('selectedPlan', selectedPlan);
        sessionStorage.setItem('selectedPrice', selectedPrice);
        
        showSuccess('form-message', 'Account created! Setting up payment...');
        
        // Create Stripe checkout
        await createStripeCheckout(data.user);
        
    } catch (error) {
        console.error('‚ùå Signup failed:', error);
        handleSignupError(error);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Start Free Trial ‚Üí';
    }
}

// ==================================================
// ADD THIS NEW FUNCTION AFTER YOUR handleSignupError FUNCTION
// ==================================================

// Create family account (no payment)
async function createFamilyAccount(email, password) {
    try {
        console.log('üëë Creating family account for:', email);

        // Create Supabase auth account
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: email,
            password: password
        });

        if (authError) throw authError;
        console.log('‚úÖ Family auth account created');

        // Create family member profile with lifetime Pro access
        const { error: profileError } = await supabase
            .from('user_profiles')
            .upsert({
                user_id: authData.user.id,
                email: email,
                is_family_member: true,
                subscription_status: 'active',
                subscription_plan: 'pro',
                subscription_type: 'lifetime',
                access_level: 'family_admin',
                family_access_granted_at: new Date().toISOString(),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            });

        if (profileError) throw profileError;
        console.log('‚úÖ Family profile created');

        // Create admin permissions
        const { error: adminError } = await supabase
            .from('admin_permissions')
            .upsert({
                user_id: authData.user.id,
                email: email,
                role: 'family_admin',
                permissions: ['view_users', 'manage_users', 'view_payments', 'manage_payments', 'create_promo_codes', 'manage_promo_codes', 'view_analytics', 'full_access'],
                granted_at: new Date().toISOString(),
                is_active: true
            });

        if (adminError) throw adminError;
        console.log('‚úÖ Admin permissions created');

        // Success!
        showSuccess('form-message', 'üéâ Welcome to the family! You have lifetime Pro access.');
        
        // Redirect to dashboard after 2 seconds
        setTimeout(() => {
            window.location.href = '/dashboard.html';
        }, 2000);

    } catch (error) {
        console.error('‚ùå Family account creation error:', error);
        showError('form-message', 'Account creation failed: ' + error.message);
    }
}
