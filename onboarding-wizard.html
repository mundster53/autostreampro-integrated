<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AutoStreamPro - Quick Setup</title>
  <!-- onboarding-wizard.html v3.1 - YouTube official branding for API compliance -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .wizard-container{max-width:600px;width:100%;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .progress-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:30px;color:#fff;text-align:center}
    .progress-title{font-size:1.5rem;font-weight:600;margin-bottom:20px}
    .progress-subtitle{font-size:.9rem;opacity:.9;margin-bottom:30px}
    .step-indicators{display:flex;justify-content:center;align-items:center;gap:8px;margin-bottom:10px}
    .step-item{display:flex;align-items:center}
    .step-circle{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;transition:.3s}
    .step-circle.completed{background:#10b981;color:#fff}
    .step-circle.active{background:#fff;color:#667eea;animation:pulse 2s infinite}
    .step-circle.upcoming{background:rgba(255,255,255,.3);color:rgba(255,255,255,.8)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,.7)}70%{box-shadow:0 0 0 10px rgba(255,255,255,0)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}}
    .step-line{width:40px;height:2px;background:rgba(255,255,255,.3);transition:.3s}
    .step-line.completed{background:#10b981}
    .step-labels{display:flex;justify-content:center;gap:30px;font-size:.75rem;color:rgba(255,255,255,.9)}
    .step-label{width:60px;text-align:center}
    .wizard-content{padding:40px;min-height:400px;display:flex;flex-direction:column}
    .step-title{font-size:1.3rem;color:#333;margin-bottom:10px;font-weight:600}
    .step-description{color:#666;margin-bottom:30px;font-size:.95rem}
    .platform-selection{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px}
    .platform-option{border:2px solid #e5e7eb;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:.3s;position:relative}
    .platform-option:hover{border-color:#667eea;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .platform-option.selected{border-color:#667eea;background:#f3f4ff}
    .platform-option.selected::after{content:'‚úì';position:absolute;top:10px;right:10px;background:#667eea;color:#fff;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px}
    .platform-icon{width:60px;height:60px;margin:0 auto 10px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;font-weight:700}
    .kick-icon{background:#53fc18}.twitch-icon{background:#9146ff}.youtube-icon{background:#ff0000}.tiktok-icon{background:#000}
    .platform-name{font-weight:600;color:#333;font-size:1rem}
    .input-group{margin-bottom:20px}
    .input-group label{display:block;margin-bottom:8px;font-weight:500;color:#374151;font-size:.95rem}
    .input-field{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;transition:.3s}
    .input-field:focus{outline:none;border-color:#667eea}
    .validation-message{margin-top:8px;font-size:.875rem;padding:8px 12px;border-radius:6px;display:none}
    .validation-message.success{background:#f0fdf4;color:#166534;border:1px solid #86efac;display:block}
    .validation-message.error{background:#fef2f2;color:#991b1b;border:1px solid #fca5a5;display:block}
    .wizard-navigation{display:flex;justify-content:space-between;margin-top:auto;padding-top:30px}
    .nav-btn{padding:12px 24px;border-radius:8px;font-weight:600;font-size:.95rem;cursor:pointer;transition:.2s;border:none}
    .btn-back{background:#f3f4f6;color:#6b7280}
    .btn-back:hover{background:#e5e7eb}
    .btn-next{background:#667eea;color:#fff}
    .btn-next:hover:not(:disabled){background:#5a67d8;transform:translateY(-1px)}
    .btn-next:disabled{background:#e5e7eb;color:#9ca3af;cursor:not-allowed;transform:none}
    .step-content{display:none}
    .step-content.active{display:block;animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .success-screen{text-align:center;padding:40px}
    .success-icon{font-size:4rem;color:#10b981;margin-bottom:20px}
    /* YouTube Official Branding - API Compliance III.F.2 */
    .yt-connect-btn{display:flex;align-items:center;justify-content:center;gap:10px;background:#fff;border:1px solid #ccc;border-radius:4px;padding:12px 24px;cursor:pointer;font-size:15px;font-family:'Roboto',sans-serif;color:#606060;transition:.2s;width:100%}
    .yt-connect-btn:hover{background:#f8f8f8;border-color:#999}
    .yt-connect-btn svg{width:24px;height:17px}
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="progress-header">
      <h1 class="progress-title">üöÄ AutoStreamPro Quick Setup</h1>
      <p class="progress-subtitle">Get your clips automated in 3 minutes!</p>

      <!-- 4 steps now instead of 5 -->
      <div class="step-indicators">
        <div class="step-item"><div class="step-circle active" id="step1">1</div></div>
        <div class="step-line" id="line1"></div>
        <div class="step-item"><div class="step-circle upcoming" id="step2">2</div></div>
        <div class="step-line" id="line2"></div>
        <div class="step-item"><div class="step-circle upcoming" id="step3">3</div></div>
        <div class="step-line" id="line3"></div>
        <div class="step-item"><div class="step-circle upcoming" id="step4">4</div></div>
      </div>

      <div class="step-labels">
        <div class="step-label">Stream</div>
        <div class="step-label">Connect</div>
        <div class="step-label">Publish</div>
        <div class="step-label">Done</div>
      </div>
    </div>

    <div class="wizard-content">
      <!-- Step 1: Platform Selection -->
      <div class="step-content active" id="content1">
        <h2 class="step-title">Where do you stream?</h2>
        <p class="step-description">Choose your main streaming platform. You can add more later.</p>

        <div class="platform-selection">
          <div class="platform-option" data-platform="kick">
            <div class="platform-icon kick-icon">K</div><div class="platform-name">Kick</div>
          </div>
          <div class="platform-option" data-platform="twitch">
            <div class="platform-icon twitch-icon">T</div><div class="platform-name">Twitch</div>
          </div>
          <div class="platform-option" data-platform="youtube">
            <div class="platform-icon youtube-icon">YT</div><div class="platform-name">YouTube</div>
          </div>
        </div>
      </div>

      <!-- Step 2: Connect Platform -->
      <div class="step-content" id="content2">
        <h2 class="step-title">Connect your <span id="platformName">Platform</span></h2>
        <p class="step-description">We'll monitor your stream and create clips automatically.</p>

        <div id="kickConnection" style="display:none">
          <div class="input-group">
            <label>Your Kick Username</label>
            <input type="text" id="kickUsername" class="input-field" placeholder="Enter your Kick username"/>
            <div class="validation-message" id="kickValidation"></div>
          </div>
          <button class="nav-btn btn-next" id="kickVerifyBtn" style="width:100%;margin-top:15px">Verify Username</button>
        </div>

        <div id="twitchConnection" style="display:none">
          <button class="nav-btn btn-next" id="twitchConnectBtn" style="width:100%;background:#9146ff">Connect with Twitch</button>
          <p style="color:#666;font-size:.9rem;text-align:center;margin-top:15px">You'll be redirected to Twitch to authorize the connection</p>
        </div>

        <div id="youtubeConnection" style="display:none">
          <button
            class="yt-connect-btn"
            id="youtubeConnectBtn"
            type="button">
            <svg viewBox="0 0 28 20" xmlns="http://www.w3.org/2000/svg"><path d="M27.97 3.12C27.64 1.89 26.68.93 25.45.6 23.22 0 14.29 0 14.29 0S5.35 0 3.12.6C1.89.93.93 1.89.6 3.12 0 5.35 0 10 0 10s0 4.65.6 6.88c.33 1.23 1.29 2.19 2.52 2.52 2.23.6 11.17.6 11.17.6s8.93 0 11.16-.6c1.23-.33 2.19-1.29 2.52-2.52.6-2.23.6-6.88.6-6.88s0-4.65-.6-6.88z" fill="#FF0033"/><path d="M11.43 14.29l7.42-4.29-7.42-4.29v8.58z" fill="#fff"/></svg>
            Sign in with YouTube
          </button>
          <p style="color:#666;font-size:.9rem;text-align:center;margin-top:15px">You'll be redirected to YouTube to authorize the connection</p>
        </div>
      </div>

      <!-- Step 3: Publishing Platforms -->
      <div class="step-content" id="content3">
        <h2 class="step-title">Where should we post your clips?</h2>
        <p class="step-description">Connect at least one platform to share your viral moments.</p>

        <div class="platform-selection">
          <div class="platform-option" data-publish="youtube">
            <div class="platform-icon youtube-icon">YT</div><div class="platform-name">YouTube</div>
          </div>
          <div class="platform-option" data-publish="tiktok">
            <div class="platform-icon tiktok-icon">T</div><div class="platform-name">TikTok</div>
          </div>
        </div>

        <div id="publishConnections" style="margin-top:20px"></div>
      </div>

      <!-- Step 4: Complete (was Step 5) -->
      <div class="step-content" id="content4">
        <h2 class="step-title">Almost done!</h2>
        <p class="step-description">Click below to complete your setup.</p>
        <div style="text-align:center;padding:40px">
          <div style="font-size:3rem">üéÆ</div>
          <p style="margin-top:20px">Your streaming setup will be ready to go!</p>
          <p style="margin-top:10px;color:#666;font-size:.9rem">We'll automatically detect your best moments and create clips.</p>
        </div>
      </div>

      <!-- Success Screen -->
      <div class="step-content" id="contentSuccess">
        <div class="success-screen">
          <div class="success-icon">‚úÖ</div>
          <h2 style="font-size:1.5rem;color:#333;margin-bottom:10px">You're all set!</h2>
          <p style="color:#666;margin-bottom:30px">Your automatic clip system is ready</p>
          <button class="nav-btn btn-next" onclick="window.location.href='/dashboard.html'" style="width:100%;background:#10b981">Go to Dashboard</button>
        </div>
      </div>

      <!-- Navigation -->
      <div class="wizard-navigation" id="wizardNav">
        <button class="nav-btn btn-back" id="backBtn" style="visibility:hidden">‚Üê Back</button>
        <button class="nav-btn btn-next" id="nextBtn" disabled>Next ‚Üí</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Supabase init ----------
    const supabaseUrl = 'https://dykxhmdozgccawkbxejd.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5a3hobWRvemdjY2F3a2J4ZWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwNTY2NTUsImV4cCI6MjA2NTYzMjY1NX0.SFxWx_Gk2ReRZCNpmAhKJ0jEeANjqeDLtQuU_MnGTlg';
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ---------- Wizard state ----------
    let currentStep = 1;
    const totalSteps = 4; // Changed from 5 to 4
    let selectedPlatform = null;
    let selectedPublishPlatforms = [];
    
    // FIXED threshold - admin controlled, not user controlled
    const FIXED_THRESHOLD = 0.50; // 50%

    // --- YouTube connection state
    let yConnected = false;

    async function fetchConnections() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return { youtube: false };
      const { data, error } = await supabase
        .from('streaming_connections')
        .select('youtube_connected')
        .eq('user_id', user.id)
        .maybeSingle();
      return { youtube: !!(data && data.youtube_connected) };
    }

    function markYouTubeSelected() {
      const ytTile = document.querySelector('.platform-option[data-publish="youtube"]');
      if (ytTile && !ytTile.classList.contains('selected')) ytTile.classList.add('selected');
      if (!selectedPublishPlatforms.includes('youtube')) selectedPublishPlatforms.push('youtube');
      if (typeof updateNavigationState === 'function') updateNavigationState();
      const box = document.getElementById('publishConnections');
      if (box) {
        box.innerHTML = `<div style="padding:12px;border-radius:8px;background:#ecfdf5;color:#065f46">
          YouTube connected ‚úî ‚Äî we'll publish clips there.
        </div>`;
      }
    }

    // ---------- Platform connections ----------
    async function connectKick() {
      const username = (document.getElementById('kickUsername')?.value || '').trim();
      const valEl = document.getElementById('kickValidation');
      if (!username) {
        if (valEl) {
          valEl.className = 'validation-message error';
          valEl.textContent = 'Please enter your Kick username';
          valEl.style.display = 'block';
        }
        return;
      }

      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) { alert('Please log in first'); window.location.href='/login.html'; return; }

      try {
        console.log('[Kick Connect] Attempting connection for user:', user.id, 'username:', username);
        
        const resp = await fetch('https://autostreampro-backend-production.up.railway.app/api/connect-kick', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userId: user.id, kickUsername: username })
        });
        
        console.log('[Kick Connect] Response status:', resp.status);
        
        const result = await resp.json();
        console.log('[Kick Connect] Result:', result);
        
        if (result.success) {
          if (valEl) {
            valEl.className = 'validation-message success';
            valEl.textContent = `‚úì Connected: ${username}`;
            valEl.style.display = 'block';
          }
          document.getElementById('nextBtn').disabled = false;
        } else {
          console.error('[Kick Connect] Server returned error:', result.error);
          if (valEl) {
            valEl.className = 'validation-message error';
            valEl.textContent = result.error || 'Could not verify that Kick channel';
            valEl.style.display = 'block';
          }
        }
      } catch (e) {
        console.error('[Kick Connect] Network/fetch error:', e.name, e.message);
        if (valEl) {
          valEl.className = 'validation-message error';
          valEl.textContent = 'Network error - try refreshing or use a different browser. (Error: ' + e.message + ')';
          valEl.style.display = 'block';
        }
      }
    }

    async function connectTwitch() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) { 
        alert('Please log in first'); 
        window.location.href='/login.html'; 
        return; 
      }
      
      const returnTo = encodeURIComponent('https://www.autostreampro.com/onboarding-wizard.html');
      window.location.href = `https://autostreampro-backend-production.up.railway.app/api/auth/twitch?userId=${user.id}&return_to=${returnTo}`;
    }

    // ---------- UI helpers ----------
    function showPlatformConnection() {
      const nameEl = document.getElementById('platformName');
      if (nameEl && selectedPlatform) nameEl.textContent = selectedPlatform.charAt(0).toUpperCase()+selectedPlatform.slice(1);

      document.getElementById('kickConnection').style.display = 'none';
      document.getElementById('twitchConnection').style.display = 'none';
      document.getElementById('youtubeConnection').style.display = 'none';

      if (selectedPlatform === 'kick') document.getElementById('kickConnection').style.display = 'block';
      if (selectedPlatform === 'twitch') document.getElementById('twitchConnection').style.display = 'block';
      if (selectedPlatform === 'youtube') document.getElementById('youtubeConnection').style.display = 'block';

      if (currentStep === 2) document.getElementById('nextBtn').disabled = true;
    }

    function nextStep() {
      if (currentStep < totalSteps) {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.getElementById(`step${currentStep}`).classList.add('completed');
        document.getElementById(`step${currentStep}`).innerHTML = '‚úì';
        if (currentStep < totalSteps) document.getElementById(`line${currentStep}`).classList.add('completed');
        document.getElementById(`content${currentStep}`).classList.remove('active');

        currentStep++;
        document.getElementById(`content${currentStep}`).classList.add('active');
        document.getElementById(`step${currentStep}`).classList.remove('upcoming');
        document.getElementById(`step${currentStep}`).classList.add('active');

        updateNavigationState();
        if (currentStep === 2) showPlatformConnection();
        if (currentStep === totalSteps) document.getElementById('nextBtn').textContent='Complete Setup';
      } else {
        completeSetup();
      }
    }

    function previousStep() {
      if (currentStep > 1) {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.getElementById(`step${currentStep}`).classList.add('upcoming');
        document.getElementById(`step${currentStep}`).innerHTML = currentStep;
        if (currentStep > 1) document.getElementById(`line${currentStep-1}`).classList.remove('completed');
        document.getElementById(`content${currentStep}`).classList.remove('active');

        currentStep--;
        document.getElementById(`content${currentStep}`).classList.add('active');
        document.getElementById(`step${currentStep}`).classList.remove('completed');
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById(`step${currentStep}`).innerHTML = currentStep;

        updateNavigationState();
      }
    }

    function updateNavigationState() {
      const backBtn = document.getElementById('backBtn');
      const nextBtn = document.getElementById('nextBtn');
      backBtn.style.visibility = currentStep > 1 ? 'visible' : 'hidden';

      if (currentStep === 1) nextBtn.disabled = !selectedPlatform;
      else if (currentStep === 3) nextBtn.disabled = selectedPublishPlatforms.length === 0;
      else if (currentStep === 2) nextBtn.disabled = true;
      else nextBtn.disabled = false;

      nextBtn.textContent = currentStep === totalSteps ? 'Complete Setup' : 'Next ‚Üí';
    }

    async function completeSetup() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) { alert('Please log in first'); window.location.href='/login.html'; return; }

      try {
        // Save preferences with FIXED threshold (admin controlled)
        const { error } = await supabase
          .from('user_preferences')
          .upsert({
            user_id: user.id,
            viral_threshold: FIXED_THRESHOLD * 100, // Store as percentage (50)
            clip_length: 30,
            auto_clips: true,
            auto_titles: true,
            auto_post: true,
            updated_at: new Date()
          }, { onConflict: 'user_id' });
        if (error) throw error;

        // Persist decimal threshold for backend (0.50)
        const { error: upErr } = await supabase
          .from('user_profiles')
          .upsert(
            { user_id: user.id, virality_threshold: FIXED_THRESHOLD },
            { onConflict: 'user_id' }
          );
        if (upErr) throw upErr;

        // Success UI
        document.getElementById('content4').classList.remove('active');
        document.getElementById('contentSuccess').classList.add('active');
        document.getElementById('wizardNav').style.display='none';
        document.getElementById('step4').classList.remove('active');
        document.getElementById('step4').classList.add('completed');
        document.getElementById('step4').innerHTML='‚úì';
        document.getElementById('line3').classList.add('completed');
      } catch(e) {
        console.error('Error saving preferences:', e);
        alert('Failed to save settings. Please try again.');
      }
    }

    // ---------- Auth & onboarding checks ----------
   async function checkAuth() {
      try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (!user || error) {
          await supabaseClient.auth.signOut();
          window.location.href='/login.html';
        }
      } catch (e) {
        await supabaseClient.auth.signOut();
        window.location.href='/login.html';
      }
    }

    async function checkOnboardingStatus() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return;
      const { data: connections } = await supabaseClient
        .from('streaming_connections')
        .select('id')
        .eq('user_id', user.id)
        .limit(1);
      if (!connections || connections.length === 0) return;
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuth();
      await checkOnboardingStatus();

      // Load current connections so Step 3 behaves correctly
      try {
        const conn = await fetchConnections();
        yConnected = conn.youtube;
        if (yConnected) markYouTubeSelected();
        window.yConnected = yConnected;
      } catch {}

      // Step 1 selections
      document.querySelectorAll('[data-platform]').forEach(el=>{
        el.addEventListener('click', ()=>{
          document.querySelectorAll('[data-platform]').forEach(x=>x.classList.remove('selected'));
          el.classList.add('selected');
          selectedPlatform = el.getAttribute('data-platform');
          updateNavigationState();
          yConnected = true;
          markYouTubeSelected();
        });
      });

      // Step 3 selections
      document.querySelectorAll('[data-publish]').forEach(el=>{
        el.addEventListener('click', ()=>{
          el.classList.toggle('selected');
          const p = el.getAttribute('data-publish');
          if (el.classList.contains('selected')) {
            if (!selectedPublishPlatforms.includes(p)) selectedPublishPlatforms.push(p);
          } else {
            selectedPublishPlatforms = selectedPublishPlatforms.filter(x=>x!==p);
          }
          updateNavigationState();
        });
      });

      // Handle OAuth returns
      const urlParams = new URLSearchParams(window.location.search);

      // --- YouTube: handle callback (?youtube=connected) ---
      const youtubeStatus = urlParams.get('youtube');
      if (youtubeStatus === 'connected') {
        selectedPlatform = 'youtube';
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('completed');
        document.getElementById('step1').innerHTML='‚úì';
        document.getElementById('line1').classList.add('completed');
        document.getElementById('step2').classList.remove('upcoming');
        document.getElementById('step2').classList.add('completed');
        document.getElementById('step2').innerHTML='‚úì';
        document.getElementById('line2').classList.add('completed');
        document.getElementById('content1').classList.remove('active');
        document.getElementById('content2').classList.remove('active');
        currentStep = 3;
        document.getElementById('content3').classList.add('active');
        document.getElementById('step3').classList.remove('upcoming');
        document.getElementById('step3').classList.add('active');
        
        yConnected = true;
        window.yConnected = true;
        markYouTubeSelected();
        updateNavigationState();
        
        window.history.replaceState({}, document.title, '/onboarding-wizard.html');
      }

      // Buttons
      document.getElementById('nextBtn').addEventListener('click', nextStep);
      document.getElementById('backBtn').addEventListener('click', previousStep);
      document.getElementById('kickVerifyBtn').addEventListener('click', connectKick);
      document.getElementById('twitchConnectBtn').addEventListener('click', connectTwitch);

      const ytWizardBtn = document.getElementById('youtubeConnectBtn');
      if (ytWizardBtn) {
        ytWizardBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          
          const { data: { user } } = await supabaseClient.auth.getUser();
          if (!user) { 
            alert('Please log in first'); 
            window.location.href='/login.html'; 
            return; 
          }
          
          if (yConnected) {
            selectedPlatform = 'youtube';
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step1').innerHTML='‚úì';
            document.getElementById('line1').classList.add('completed');
            document.getElementById('step2').classList.remove('upcoming');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step2').innerHTML='‚úì';
            document.getElementById('line2').classList.add('completed');
            document.getElementById('content1').classList.remove('active');
            document.getElementById('content2').classList.remove('active');
            currentStep = 3;
            document.getElementById('content3').classList.add('active');
            document.getElementById('step3').classList.remove('upcoming');
            document.getElementById('step3').classList.add('active');
            markYouTubeSelected();
            updateNavigationState();
            return;
          }
          
          const returnTo = encodeURIComponent('https://www.autostreampro.com/onboarding-wizard.html');
          window.location.href = `https://autostreampro-backend-production.up.railway.app/api/auth/youtube?userId=${user.id}&return_to=${returnTo}`;
        });
      }

      // Kick enter key
      const kickInput = document.getElementById('kickUsername');
      if (kickInput) kickInput.addEventListener('keypress', e=>{ if (e.key==='Enter') connectKick(); });

      // Handle Twitch OAuth return
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      if (code && state === 'twitch') {
        selectedPlatform = 'twitch';
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('completed');
        document.getElementById('step1').innerHTML='‚úì';
        document.getElementById('line1').classList.add('completed');
        document.getElementById('step2').classList.remove('upcoming');
        document.getElementById('step2').classList.add('completed');
        document.getElementById('step2').innerHTML='‚úì';
        document.getElementById('line2').classList.add('completed');
        document.getElementById('content1').classList.remove('active');
        document.getElementById('content2').classList.remove('active');
        currentStep = 3;
        document.getElementById('content3').classList.add('active');
        document.getElementById('step3').classList.remove('upcoming');
        document.getElementById('step3').classList.add('active');
        updateNavigationState();
        window.history.replaceState({}, document.title, '/onboarding-wizard.html');
      }

      // DEV: jump straight to Step 3 if ?step=3
      if (urlParams.get('step') === '3') {
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step1').classList.add('completed');
        document.getElementById('step1').innerHTML='‚úì';
        document.getElementById('line1').classList.add('completed');
        document.getElementById('step2').classList.remove('upcoming');
        document.getElementById('step2').classList.add('completed');
        document.getElementById('step2').innerHTML='‚úì';
        document.getElementById('line2').classList.add('completed');
        document.getElementById('content1').classList.remove('active');
        document.getElementById('content2').classList.remove('active');
        currentStep = 3;
        document.getElementById('content3').classList.add('active');
        document.getElementById('step3').classList.remove('upcoming');
        document.getElementById('step3').classList.add('active');
        updateNavigationState();
      }

      // DEV: immediately start TikTok OAuth if ?start=tiktok
      if (urlParams.get('start') === 'tiktok') {
        const { data: { user: oauthUser } } = await supabaseClient.auth.getUser();
        if (oauthUser) {
          const returnTo = encodeURIComponent('/onboarding-wizard.html#tiktok');
          sessionStorage.setItem('tiktok_return_to', '/onboarding-wizard.html#tiktok');
          window.location.href = `/auth/tiktok?user=${encodeURIComponent(oauthUser.id)}&direct=1&return_to=${returnTo}`;
          return;
        }
      }

      // Make shared state/functions available
      window.yConnected = yConnected;
      window.selectedPublishPlatforms = selectedPublishPlatforms;
      window.updateNavigationState = updateNavigationState;
    });
  </script>

  <script>
    (function () {
      function ready(fn){ document.readyState !== 'loading' ? fn() : document.addEventListener('DOMContentLoaded', fn); }
      function setStatus(html, isError=false) {
        const box = document.getElementById('publishConnections');
        if (!box) return;
        box.innerHTML = `<div style="padding:12px;border-radius:8px;${isError ? 'background:#fee2e2;color:#991b1b' : 'background:#ecfdf5;color:#065f46'}">${html}</div>`;
      }
      function q(name){ return document.getElementById(name); }

      ready(function () {
        const tiktokTile = document.querySelector('.platform-option[data-publish="tiktok"]');
        const youtubeTile = document.querySelector('.platform-option[data-publish="youtube"]');

        // Start TikTok OAuth when the TikTok tile is clicked
        if (tiktokTile) {
          tiktokTile.style.cursor = 'pointer';
          tiktokTile.addEventListener('click', async function () {
            try {
              const { data: { user } } = await supabaseClient.auth.getUser();
              if (!user) { setStatus('Please log in first.', true); window.location.href='/login.html'; return; }
              const returnTo = encodeURIComponent('/onboarding-wizard.html#tiktok');
              sessionStorage.setItem('tiktok_return_to', '/onboarding-wizard.html#tiktok');
              window.location.href = `/auth/tiktok?user=${encodeURIComponent(user.id)}&direct=0&return_to=${returnTo}`;
            } catch (e) {
              setStatus('Could not start TikTok connect. Please try again.', true);
            }
          });
        }

        // YouTube tile: if already connected, just select; otherwise start OAuth
        if (youtubeTile && !youtubeTile.dataset.wired) {
          youtubeTile.dataset.wired = '1';
          youtubeTile.style.cursor = 'pointer';
          youtubeTile.addEventListener('click', async function () {
            try {
              if (window.yConnected) {
                if (!youtubeTile.classList.contains('selected')) youtubeTile.classList.add('selected');
                if (Array.isArray(window.selectedPublishPlatforms) && !window.selectedPublishPlatforms.includes('youtube')) {
                  window.selectedPublishPlatforms.push('youtube');
                }
                if (typeof window.updateNavigationState === 'function') window.updateNavigationState();
                return;
              }
              const { data: { user } } = await supabaseClient.auth.getUser();
              if (user) {
                window.location.href = `https://autostreampro-backend-production.up.railway.app/api/auth/youtube?userId=${user.id}&return_to=${encodeURIComponent('https://www.autostreampro.com/onboarding-wizard.html')}`;
              }
            } catch {
              console.error('YouTube auth failed');
            }
          });
        }

        // Handle return from TikTok: land on /onboarding-wizard.html#tiktok
        if (location.hash === '#tiktok') {
          try {
            q('content1')?.classList.remove('active');
            q('content2')?.classList.remove('active');
            q('content3')?.classList.add('active');

            q('step1')?.classList.remove('active'); q('step1')?.classList.add('completed'); if (q('step1')) q('step1').innerHTML = '‚úì';
            q('line1')?.classList.add('completed');
            q('step2')?.classList.remove('upcoming'); q('step2')?.classList.add('completed'); if (q('step2')) q('step2').innerHTML = '‚úì';
            q('line2')?.classList.add('completed');
            q('step3')?.classList.remove('upcoming'); q('step3')?.classList.add('active');
          } catch {}

          const tile = tiktokTile;
          if (tile && !tile.classList.contains('selected')) tile.classList.add('selected');
          if (Array.isArray(window.selectedPublishPlatforms)) {
            if (!window.selectedPublishPlatforms.includes('tiktok')) window.selectedPublishPlatforms.push('tiktok');
          }
          if (typeof window.updateNavigationState === 'function') window.updateNavigationState();

          const err = new URLSearchParams(window.location.search).get('err');
          if (err) {
            const msgMap = {
              missing_env: 'TikTok auth is misconfigured on the server (missing env vars).',
              token_exchange_failed: 'TikTok did not grant access. Please try again.',
              db_upsert_failed: 'Connected to TikTok, but failed saving your connection. Try again.',
              unexpected_error: 'Unexpected error while connecting TikTok. Please try again.'
            };
            setStatus(`TikTok: ${msgMap[err] || ('Error: ' + err)}`, true);
          } else {
            setStatus('TikTok connected ‚úî Auto-post enabled for your account.');
          }

          history.replaceState({}, document.title, '/onboarding-wizard.html#tiktok');
        }
      });
    })();
  </script>

</body>
</html>
